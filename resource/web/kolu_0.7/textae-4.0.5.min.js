/*! textae 4.1.1 02-10-2014 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){"use strict";function c(a){function b(a){return null===j?void l.push(a):void f(function(){var b=j?a.onFulfilled:a.onRejected;if(null===b)return void(j?a.resolve:a.reject)(k);var c;try{c=b(k)}catch(d){return void a.reject(d)}a.resolve(c)})}function g(a){try{if(a===m)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var b=a.then;if("function"==typeof b)return void e(b.bind(a),g,h)}j=!0,k=a,i()}catch(c){h(c)}}function h(a){j=!1,k=a,i()}function i(){for(var a=0,c=l.length;c>a;a++)b(l[a]);l=null}if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");var j=null,k=null,l=[],m=this;this.then=function(a,e){return new c(function(c,f){b(new d(a,e,c,f))})},e(a,g,h)}function d(a,b,c,d){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.resolve=c,this.reject=d}function e(a,b,c){var d=!1;try{a(function(a){d||(d=!0,b(a))},function(a){d||(d=!0,c(a))})}catch(e){if(d)return;d=!0,c(e)}}var f=a("asap");b.exports=c},{asap:3}],2:[function(a,b){"use strict";function c(a){this.then=function(b){return"function"!=typeof b?this:new d(function(c,d){e(function(){try{c(b(a))}catch(e){d(e)}})})}}var d=a("./core.js"),e=a("asap");b.exports=d,c.prototype=Object.create(d.prototype);var f=new c(!0),g=new c(!1),h=new c(null),i=new c(void 0),j=new c(0),k=new c("");d.resolve=function(a){if(a instanceof d)return a;if(null===a)return h;if(void 0===a)return i;if(a===!0)return f;if(a===!1)return g;if(0===a)return j;if(""===a)return k;if("object"==typeof a||"function"==typeof a)try{var b=a.then;if("function"==typeof b)return new d(b.bind(a))}catch(e){return new d(function(a,b){b(e)})}return new c(a)},d.from=d.cast=function(a){var b=new Error("Promise.from and Promise.cast are deprecated, use Promise.resolve instead");return b.name="Warning",console.warn(b.stack),d.resolve(a)},d.denodeify=function(a,b){return b=b||1/0,function(){var c=this,e=Array.prototype.slice.call(arguments);return new d(function(d,f){for(;e.length&&e.length>b;)e.pop();e.push(function(a,b){a?f(a):d(b)}),a.apply(c,e)})}},d.nodeify=function(a){return function(){var b=Array.prototype.slice.call(arguments),c="function"==typeof b[b.length-1]?b.pop():null;try{return a.apply(this,arguments).nodeify(c)}catch(f){if(null===c||"undefined"==typeof c)return new d(function(a,b){b(f)});e(function(){c(f)})}}},d.all=function(){var a=1===arguments.length&&Array.isArray(arguments[0]),b=Array.prototype.slice.call(a?arguments[0]:arguments);if(!a){var c=new Error("Promise.all should be called with a single array, calling it with multiple arguments is deprecated");c.name="Warning",console.warn(c.stack)}return new d(function(a,c){function d(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){d(f,a)},c)}b[f]=g,0===--e&&a(b)}catch(i){c(i)}}if(0===b.length)return a([]);for(var e=b.length,f=0;f<b.length;f++)d(f,b[f])})},d.reject=function(a){return new d(function(b,c){c(a)})},d.race=function(a){return new d(function(b,c){a.forEach(function(a){d.resolve(a).then(b,c)})})},d.prototype.done=function(){var a=arguments.length?this.then.apply(this,arguments):this;a.then(null,function(a){e(function(){throw a})})},d.prototype.nodeify=function(a){return"function"!=typeof a?this:void this.then(function(b){e(function(){a(null,b)})},function(b){e(function(){a(b)})})},d.prototype["catch"]=function(a){return this.then(null,a)}},{"./core.js":1,asap:3}],3:[function(a,b){(function(a){function c(){for(;e.next;){e=e.next;var a=e.task;e.task=void 0;var b=e.domain;b&&(e.domain=void 0,b.enter());try{a()}catch(d){if(i)throw b&&b.exit(),setTimeout(c,0),b&&b.enter(),d;setTimeout(function(){throw d},0)}b&&b.exit()}g=!1}function d(b){f=f.next={task:b,domain:i&&a.domain,next:null},g||(g=!0,h())}var e={task:void 0,next:null},f=e,g=!1,h=void 0,i=!1;if("undefined"!=typeof a&&a.nextTick)i=!0,h=function(){a.nextTick(c)};else if("function"==typeof setImmediate)h="undefined"!=typeof window?setImmediate.bind(window,c):function(){setImmediate(c)};else if("undefined"!=typeof MessageChannel){var j=new MessageChannel;j.port1.onmessage=c,h=function(){j.port2.postMessage(0)}}else h=function(){setTimeout(c,0)};b.exports=d}).call(this,a("JkpR2F"))},{JkpR2F:4}],4:[function(a,b){function c(){}var d=b.exports={};d.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){var b=a.source;if((b===window||null===b)&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){var d=c.shift();d()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.on=c,d.addListener=c,d.once=c,d.off=c,d.removeListener=c,d.removeAllListeners=c,d.emit=c,d.binding=function(){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(){throw new Error("process.chdir is not supported")}},{}],5:[function(a,b,c){(function(a){!function(d){function e(a){throw RangeError(H[a])}function f(a,b){for(var c=a.length;c--;)a[c]=b(a[c]);return a}function g(a,b){return f(a.split(G),b).join(".")}function h(a){for(var b,c,d=[],e=0,f=a.length;f>e;)b=a.charCodeAt(e++),b>=55296&&56319>=b&&f>e?(c=a.charCodeAt(e++),56320==(64512&c)?d.push(((1023&b)<<10)+(1023&c)+65536):(d.push(b),e--)):d.push(b);return d}function i(a){return f(a,function(a){var b="";return a>65535&&(a-=65536,b+=K(a>>>10&1023|55296),a=56320|1023&a),b+=K(a)}).join("")}function j(a){return 10>a-48?a-22:26>a-65?a-65:26>a-97?a-97:w}function k(a,b){return a+22+75*(26>a)-((0!=b)<<5)}function l(a,b,c){var d=0;for(a=c?J(a/A):a>>1,a+=J(a/b);a>I*y>>1;d+=w)a=J(a/I);return J(d+(I+1)*a/(a+z))}function m(a){var b,c,d,f,g,h,k,m,n,o,p=[],q=a.length,r=0,s=C,t=B;for(c=a.lastIndexOf(D),0>c&&(c=0),d=0;c>d;++d)a.charCodeAt(d)>=128&&e("not-basic"),p.push(a.charCodeAt(d));for(f=c>0?c+1:0;q>f;){for(g=r,h=1,k=w;f>=q&&e("invalid-input"),m=j(a.charCodeAt(f++)),(m>=w||m>J((v-r)/h))&&e("overflow"),r+=m*h,n=t>=k?x:k>=t+y?y:k-t,!(n>m);k+=w)o=w-n,h>J(v/o)&&e("overflow"),h*=o;b=p.length+1,t=l(r-g,b,0==g),J(r/b)>v-s&&e("overflow"),s+=J(r/b),r%=b,p.splice(r++,0,s)}return i(p)}function n(a){var b,c,d,f,g,i,j,m,n,o,p,q,r,s,t,u=[];for(a=h(a),q=a.length,b=C,c=0,g=B,i=0;q>i;++i)p=a[i],128>p&&u.push(K(p));for(d=f=u.length,f&&u.push(D);q>d;){for(j=v,i=0;q>i;++i)p=a[i],p>=b&&j>p&&(j=p);for(r=d+1,j-b>J((v-c)/r)&&e("overflow"),c+=(j-b)*r,b=j,i=0;q>i;++i)if(p=a[i],b>p&&++c>v&&e("overflow"),p==b){for(m=c,n=w;o=g>=n?x:n>=g+y?y:n-g,!(o>m);n+=w)t=m-o,s=w-o,u.push(K(k(o+t%s,0))),m=J(t/s);u.push(K(k(m,0))),g=l(c,r,d==f),c=0,++d}++c,++b}return u.join("")}function o(a){return g(a,function(a){return E.test(a)?m(a.slice(4).toLowerCase()):a})}function p(a){return g(a,function(a){return F.test(a)?"xn--"+n(a):a})}var q="object"==typeof c&&c,r="object"==typeof b&&b&&b.exports==q&&b,s="object"==typeof a&&a;(s.global===s||s.window===s)&&(d=s);var t,u,v=2147483647,w=36,x=1,y=26,z=38,A=700,B=72,C=128,D="-",E=/^xn--/,F=/[^ -~]/,G=/\x2E|\u3002|\uFF0E|\uFF61/g,H={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},I=w-x,J=Math.floor,K=String.fromCharCode;if(t={version:"1.2.4",ucs2:{decode:h,encode:i},decode:m,encode:n,toASCII:p,toUnicode:o},"function"==typeof define&&"object"==typeof define.amd&&define.amd)define("punycode",function(){return t});else if(q&&!q.nodeType)if(r)r.exports=t;else for(u in t)t.hasOwnProperty(u)&&(q[u]=t[u]);else d.punycode=t}(this)}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(a,b){"use strict";function c(a,b){return Object.prototype.hasOwnProperty.call(a,b)}b.exports=function(a,b,e,f){b=b||"&",e=e||"=";var g={};if("string"!=typeof a||0===a.length)return g;var h=/\+/g;a=a.split(b);var i=1e3;f&&"number"==typeof f.maxKeys&&(i=f.maxKeys);var j=a.length;i>0&&j>i&&(j=i);for(var k=0;j>k;++k){var l,m,n,o,p=a[k].replace(h,"%20"),q=p.indexOf(e);q>=0?(l=p.substr(0,q),m=p.substr(q+1)):(l=p,m=""),n=decodeURIComponent(l),o=decodeURIComponent(m),c(g,n)?d(g[n])?g[n].push(o):g[n]=[g[n],o]:g[n]=o}return g};var d=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)}},{}],7:[function(a,b){"use strict";function c(a,b){if(a.map)return a.map(b);for(var c=[],d=0;d<a.length;d++)c.push(b(a[d],d));return c}var d=function(a){switch(typeof a){case"string":return a;case"boolean":return a?"true":"false";case"number":return isFinite(a)?a:"";default:return""}};b.exports=function(a,b,g,h){return b=b||"&",g=g||"=",null===a&&(a=void 0),"object"==typeof a?c(f(a),function(f){var h=encodeURIComponent(d(f))+g;return e(a[f])?c(a[f],function(a){return h+encodeURIComponent(d(a))}).join(b):h+encodeURIComponent(d(a[f]))}).join(b):h?encodeURIComponent(d(h))+g+encodeURIComponent(d(a)):""};var e=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},f=Object.keys||function(a){var b=[];for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b.push(c);return b}},{}],8:[function(a,b,c){"use strict";c.decode=c.parse=a("./decode"),c.encode=c.stringify=a("./encode")},{"./decode":6,"./encode":7}],9:[function(a,b,c){function d(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function e(a,b,c){if(a&&j(a)&&a instanceof d)return a;var e=new d;return e.parse(a,b,c),e}function f(a){return i(a)&&(a=e(a)),a instanceof d?a.format():d.prototype.format.call(a)}function g(a,b){return e(a,!1,!0).resolve(b)}function h(a,b){return a?e(a,!1,!0).resolveObject(b):b}function i(a){return"string"==typeof a}function j(a){return"object"==typeof a&&null!==a}function k(a){return null===a}function l(a){return null==a}var m=a("punycode");c.parse=e,c.resolve=g,c.resolveObject=h,c.format=f,c.Url=d;var n=/^([a-z0-9.+-]+:)/i,o=/:[0-9]*$/,p=["<",">",'"',"`"," ","\r","\n","	"],q=["{","}","|","\\","^","`"].concat(p),r=["'"].concat(q),s=["%","/","?",";","#"].concat(r),t=["/","?","#"],u=255,v=/^[a-z0-9A-Z_-]{0,63}$/,w=/^([a-z0-9A-Z_-]{0,63})(.*)$/,x={javascript:!0,"javascript:":!0},y={javascript:!0,"javascript:":!0},z={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},A=a("querystring");d.prototype.parse=function(a,b,c){if(!i(a))throw new TypeError("Parameter 'url' must be a string, not "+typeof a);var d=a;d=d.trim();var e=n.exec(d);if(e){e=e[0];var f=e.toLowerCase();this.protocol=f,d=d.substr(e.length)}if(c||e||d.match(/^\/\/[^@\/]+@[^@\/]+/)){var g="//"===d.substr(0,2);!g||e&&y[e]||(d=d.substr(2),this.slashes=!0)}if(!y[e]&&(g||e&&!z[e])){for(var h=-1,j=0;j<t.length;j++){var k=d.indexOf(t[j]);-1!==k&&(-1===h||h>k)&&(h=k)}var l,o;o=-1===h?d.lastIndexOf("@"):d.lastIndexOf("@",h),-1!==o&&(l=d.slice(0,o),d=d.slice(o+1),this.auth=decodeURIComponent(l)),h=-1;for(var j=0;j<s.length;j++){var k=d.indexOf(s[j]);-1!==k&&(-1===h||h>k)&&(h=k)}-1===h&&(h=d.length),this.host=d.slice(0,h),d=d.slice(h),this.parseHost(),this.hostname=this.hostname||"";var p="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!p)for(var q=this.hostname.split(/\./),j=0,B=q.length;B>j;j++){var C=q[j];if(C&&!C.match(v)){for(var D="",E=0,F=C.length;F>E;E++)D+=C.charCodeAt(E)>127?"x":C[E];if(!D.match(v)){var G=q.slice(0,j),H=q.slice(j+1),I=C.match(w);I&&(G.push(I[1]),H.unshift(I[2])),H.length&&(d="/"+H.join(".")+d),this.hostname=G.join(".");break}}}if(this.hostname=this.hostname.length>u?"":this.hostname.toLowerCase(),!p){for(var J=this.hostname.split("."),K=[],j=0;j<J.length;++j){var L=J[j];K.push(L.match(/[^A-Za-z0-9_-]/)?"xn--"+m.encode(L):L)}this.hostname=K.join(".")}var M=this.port?":"+this.port:"",N=this.hostname||"";this.host=N+M,this.href+=this.host,p&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==d[0]&&(d="/"+d))}if(!x[f])for(var j=0,B=r.length;B>j;j++){var O=r[j],P=encodeURIComponent(O);P===O&&(P=escape(O)),d=d.split(O).join(P)}var Q=d.indexOf("#");-1!==Q&&(this.hash=d.substr(Q),d=d.slice(0,Q));var R=d.indexOf("?");if(-1!==R?(this.search=d.substr(R),this.query=d.substr(R+1),b&&(this.query=A.parse(this.query)),d=d.slice(0,R)):b&&(this.search="",this.query={}),d&&(this.pathname=d),z[f]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var M=this.pathname||"",L=this.search||"";this.path=M+L}return this.href=this.format(),this},d.prototype.format=function(){var a=this.auth||"";a&&(a=encodeURIComponent(a),a=a.replace(/%3A/i,":"),a+="@");var b=this.protocol||"",c=this.pathname||"",d=this.hash||"",e=!1,f="";this.host?e=a+this.host:this.hostname&&(e=a+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(e+=":"+this.port)),this.query&&j(this.query)&&Object.keys(this.query).length&&(f=A.stringify(this.query));var g=this.search||f&&"?"+f||"";return b&&":"!==b.substr(-1)&&(b+=":"),this.slashes||(!b||z[b])&&e!==!1?(e="//"+(e||""),c&&"/"!==c.charAt(0)&&(c="/"+c)):e||(e=""),d&&"#"!==d.charAt(0)&&(d="#"+d),g&&"?"!==g.charAt(0)&&(g="?"+g),c=c.replace(/[?#]/g,function(a){return encodeURIComponent(a)}),g=g.replace("#","%23"),b+e+c+g+d},d.prototype.resolve=function(a){return this.resolveObject(e(a,!1,!0)).format()},d.prototype.resolveObject=function(a){if(i(a)){var b=new d;b.parse(a,!1,!0),a=b}var c=new d;if(Object.keys(this).forEach(function(a){c[a]=this[a]},this),c.hash=a.hash,""===a.href)return c.href=c.format(),c;if(a.slashes&&!a.protocol)return Object.keys(a).forEach(function(b){"protocol"!==b&&(c[b]=a[b])}),z[c.protocol]&&c.hostname&&!c.pathname&&(c.path=c.pathname="/"),c.href=c.format(),c;if(a.protocol&&a.protocol!==c.protocol){if(!z[a.protocol])return Object.keys(a).forEach(function(b){c[b]=a[b]}),c.href=c.format(),c;if(c.protocol=a.protocol,a.host||y[a.protocol])c.pathname=a.pathname;else{for(var e=(a.pathname||"").split("/");e.length&&!(a.host=e.shift()););a.host||(a.host=""),a.hostname||(a.hostname=""),""!==e[0]&&e.unshift(""),e.length<2&&e.unshift(""),c.pathname=e.join("/")}if(c.search=a.search,c.query=a.query,c.host=a.host||"",c.auth=a.auth,c.hostname=a.hostname||a.host,c.port=a.port,c.pathname||c.search){var f=c.pathname||"",g=c.search||"";c.path=f+g}return c.slashes=c.slashes||a.slashes,c.href=c.format(),c}var h=c.pathname&&"/"===c.pathname.charAt(0),j=a.host||a.pathname&&"/"===a.pathname.charAt(0),m=j||h||c.host&&a.pathname,n=m,o=c.pathname&&c.pathname.split("/")||[],e=a.pathname&&a.pathname.split("/")||[],p=c.protocol&&!z[c.protocol];if(p&&(c.hostname="",c.port=null,c.host&&(""===o[0]?o[0]=c.host:o.unshift(c.host)),c.host="",a.protocol&&(a.hostname=null,a.port=null,a.host&&(""===e[0]?e[0]=a.host:e.unshift(a.host)),a.host=null),m=m&&(""===e[0]||""===o[0])),j)c.host=a.host||""===a.host?a.host:c.host,c.hostname=a.hostname||""===a.hostname?a.hostname:c.hostname,c.search=a.search,c.query=a.query,o=e;else if(e.length)o||(o=[]),o.pop(),o=o.concat(e),c.search=a.search,c.query=a.query;else if(!l(a.search)){if(p){c.hostname=c.host=o.shift();var q=c.host&&c.host.indexOf("@")>0?c.host.split("@"):!1;q&&(c.auth=q.shift(),c.host=c.hostname=q.shift())}return c.search=a.search,c.query=a.query,k(c.pathname)&&k(c.search)||(c.path=(c.pathname?c.pathname:"")+(c.search?c.search:"")),c.href=c.format(),c}if(!o.length)return c.pathname=null,c.path=c.search?"/"+c.search:null,c.href=c.format(),c;for(var r=o.slice(-1)[0],s=(c.host||a.host)&&("."===r||".."===r)||""===r,t=0,u=o.length;u>=0;u--)r=o[u],"."==r?o.splice(u,1):".."===r?(o.splice(u,1),t++):t&&(o.splice(u,1),t--);if(!m&&!n)for(;t--;t)o.unshift("..");!m||""===o[0]||o[0]&&"/"===o[0].charAt(0)||o.unshift(""),s&&"/"!==o.join("/").substr(-1)&&o.push("");var v=""===o[0]||o[0]&&"/"===o[0].charAt(0);if(p){c.hostname=c.host=v?"":o.length?o.shift():"";var q=c.host&&c.host.indexOf("@")>0?c.host.split("@"):!1;q&&(c.auth=q.shift(),c.host=c.hostname=q.shift())}return m=m||c.host&&o.length,m&&!v&&o.unshift(""),o.length?c.pathname=o.join("/"):(c.pathname=null,c.path=null),k(c.pathname)&&k(c.search)||(c.path=(c.pathname?c.pathname:"")+(c.search?c.search:"")),c.auth=a.auth||c.auth,c.slashes=c.slashes||a.slashes,c.href=c.format(),c},d.prototype.parseHost=function(){var a=this.host,b=o.exec(a);b&&(b=b[0],":"!==b&&(this.port=b.substr(1)),a=a.substr(0,a.length-b.length)),a&&(this.hostname=a)}},{punycode:5,querystring:8}],10:[function(a,b){var c=function(a,b,c){a.on(b,c)},d=function(a){return c(a,"dialog.close",function(){a.close()}),a},e=a("../util/ajaxAccessor"),f=a("../util/jQuerySugar"),g=a("url");b.exports=function(b,c){var h="",i=a("../util/CursorChanger")(b),j=function(a){i.startWait(),e.getAsync(a,function(b){l.trigger("load",{annotation:b,source:f.toLink(g.resolve(location.href,a))}),h=a},function(){i.endWait(),alert("connection failed.")})},k=function(){var g=function(a){return a.openAndSetParam||(a.openAndSetParam=_.compose(a.open.bind(a),function(b){this.find('[type="text"].url').val(h).trigger("input"),a.params=b})),a},k=_.compose(g,d,a("../util/dialog/GetEditorDialog")(b)),m={URL:"URL",LOCAL:"Local"},n=function(){var a=function(a){var b=a.files[0],c=new FileReader;c.onload=function(){var a=JSON.parse(this.result);l.trigger("load",{annotation:a,source:b.name+"(local file)"})},c.readAsText(b)},b=_.partial(f.Div,"textae-editor__load-dialog__row"),d=_.partial(f.Label,"textae-editor__load-dialog__label"),e=_.partial(f.Button,"Open"),g=function(){return!o.params||window.confirm(c)},h=new e("url"),i=new e("local"),n=$("<div>").append((new b).append(new d(m.URL),$('<input type="text" class="textae-editor__load-dialog__file-name url" />'),h)).on("input",'[type="text"].url',function(){f.enabled(h,this.value)}).on("click",'[type="button"].url',function(){g()&&j(f.getValueFromText(n,"url")),n.trigger("dialog.close")}).append((new b).append(new d(m.LOCAL),$('<input class="textae-editor__load-dialog__file" type="file" />'),i)).on("change",'[type="file"]',function(){f.enabled(i,this.files.length>0)}).on("click",'[type="button"].local',function(){g()&&a(n.find('[type="file"]')[0]),n.trigger("dialog.close")}),o=k("textae.dialog.load","Load Annotations",n);return o},o=function(a){var b=function(){l.trigger("save"),i.endWait()},c=function(){l.trigger("save error"),i.endWait()},d=function(a,d){i.startWait(),e.post(a,d,b,c,function(){i.endWait()})},g=function(a){var b=new Blob([a],{type:"application/json"});return URL.createObjectURL(b)},h=function(){var b=n(a).find("input[type='file']"),c=b.prop("files")[0];return c?c.name:"annotations.json"},j=_.partial(f.Div,"textae-editor__save-dialog__row"),o=_.partial(f.Label,"textae-editor__save-dialog__label"),p=new f.Button("Save","url"),q=$("<div>").append((new j).append(new o(m.URL),$('<input type="text" class="textae-editor__save-dialog__server-file-name url" />'),p)).on("input","input.url",function(){f.enabled(p,this.value)}).on("click",'[type="button"].url',function(){d(f.getValueFromText(q,"url"),r.params),q.trigger("dialog.close")}).append((new j).append(new o(m.LOCAL),$('<input type="text" class="textae-editor__save-dialog__local-file-name local">'),$('<a class="download" href="#">Download</a>'))).on("click","a.download",function(){var a=g(r.params);$(this).attr("href",a).attr("download",f.getValueFromText(q,"local")),l.trigger("save"),q.trigger("dialog.close")}).append((new j).append(new o,$('<a class="viewsource" href="#">Click to see the json source in a new window.</a>'))).on("click","a.viewsource",function(){var a=g(r.params);return window.open(a,"_blank"),l.trigger("save"),q.trigger("dialog.close"),!1}),r=k("textae.dialog.save","Save Annotations",q);return r.on("dialogopen",function(){var a=h();r.find('[type="text"].local').val(a)}),r};return{showLoad:function(a,b){n(a).openAndSetParam(b)},showSave:function(a,b){o(a).openAndSetParam(b)}}}(),l=a("../util/extendBindable")({getAnnotationFromServer:j,showAccess:_.partial(k.showLoad,b.editorId),showSave:_.partial(k.showSave,b.editorId)});return l}},{"../util/CursorChanger":34,"../util/ajaxAccessor":37,"../util/dialog/GetEditorDialog":42,"../util/extendBindable":45,"../util/jQuerySugar":48,url:9}],11:[function(a,b){var c=function(a){return $("<div>").addClass("textae-editor__type-pallet").append($("<table>")).css("position","fixed").on("click",".textae-editor__type-pallet__entity-type__label",function(){a.trigger("type.select",$(this).attr("label"))}).on("change",".textae-editor__type-pallet__entity-type__radio",function(){a.trigger("default-type.select",$(this).attr("label"))}).hide()},d={RadioButton:function(a,b){var c=$("<input>").addClass("textae-editor__type-pallet__entity-type__radio").attr({type:"radio",name:"etype",label:b});return b===a.getDefaultType()&&c.attr({title:"default type",checked:"checked"}),c},Link:function(a){return a?$("<a>").attr({href:a,target:"_blank"}).append($("<span>").addClass("textae-editor__type-pallet__link")):void 0},wrapTd:function(a){return a?$("<td>").append(a):$("<td>")}},e=function(a){var b=_.compose(d.wrapTd,_.partial(d.RadioButton,a)),c=function(a){return $("<td>").addClass("textae-editor__type-pallet__entity-type__label").attr("label",a).text(a)},e=_.compose(d.wrapTd,d.Link,a.getUri);return a.getSortedNames().map(function(d){var f=new b(d),g=new c(d),h=new e(d);return $("<tr>").addClass("textae-editor__type-pallet__entity-type").css({"background-color":a.getColor(d)}).append([f,g,h])})};b.exports=function(){var b=a("../util/extendBindable")({}),d=new c(b),f=function(){var a=function(a){var b=$(".textae-editor__type-pallet");return 0!==b.length?b.find("table").empty().end().css("width","auto"):($("body").append(a),a)},b=function(a,b){return b.find("table").append(new e(a.typeContainer)).end()},c=function(a){return a.outerHeight()+"px"===a.css("max-height")?a.css("overflow-y","scroll"):a.css("overflow-y","")},d=function(d,e,f){if(e.typeContainer&&e.typeContainer.getSortedNames().length>0){var g=_.compose(c,_.partial(b,e),a);g(d).css(f).show()}};return d}();return _.extend(b,{show:_.partial(f,d),hide:d.hide.bind(d)})}},{"../util/extendBindable":45}],12:[function(a,b){var c=function(a){var b=a.find(".textae-editor__footer .textae-editor__footer__message");if(0===b.length){b=$("<div>").addClass("textae-editor__footer__message");var c=$("<div>").addClass("textae-editor__footer").append(b);a.append(c)}return b};b.exports=function(a){var b=_.partial(c,a),d=function(a){""!==a&&b().html("Source: "+a)},e=function(a){var c=b().html();b().html(a).fadeIn().fadeOut(5e3,function(){b().html(c).removeAttr("style")})};return{updateSoruceInfo:d,showFlashMessage:e}}},{}],13:[function(a,b){var c=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},d=function(a,b){return $("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",b)},e=function(){return $("<span>").addClass("textae-control__separator")},f=function(a,b){var f={},g=_.flatten(b.map(function(a){var b=_.map(a,function(a,b){var c=new d(b,a);return f[b]={instance:c,eventValue:"textae.control.button."+b.replace(/-/g,"_")+".click"},c});return[new e].concat(b)}));return a.append(new c).append($("<span>").append(g)),f},g={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},h=function(a,b,c){var d="click";b===!0?(a.off(d).on(d,c),g.enable(a)):(a.off(d),g.disable(a))},i=function(a,b,c){_.each(c,function(c,d){var e=a[d],f=function(){return b(e.eventValue),!1};e&&h(e.instance,c,f)})};b.exports=function(a){var b=f(a,[{read:"Access [A]",write:"Save [S]"},{undo:"Undo [Z]",redo:"Redo [X]"},{replicate:"Replicate span annotation [R]","replicate-auto":"Auto replicate (Toggle)","relation-edit-mode":"Edit Relation"},{entity:"New entity [E]",pallet:"Select label [Q]","change-label":"Change label [W]"},{negation:"Negation",speculation:"Speculation"},{"delete":"Delete [D]",copy:"Copy [C]",paste:"Paste [V]"},{setting:"Setting"},{help:"Help [H]",about:"About"}]),c=a.trigger.bind(a,"textae.control.click"),d=a.trigger.bind(a,"textae.control.button.click"),e=_.partial(i,b,d),h={read:!0,setting:!0,help:!0,about:!0},j=function(a){e(_.extend({},b,h,a))},k=function(a,c){var d=b[a].instance;c?g.push(d):g.unpush(d)};return a.on("click",c),a.updateAllButtonEnableState=j,a.updateButtonPushState=k,a}},{}],14:[function(a,b){var c=function(){var a={"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n","–"],"non-edge characters":[" ","\n"]},b={delimiterCharacters:null,nonEdgeCharacters:null,reset:function(){this.set(a)},set:function(c){var d=_.extend({},a,c);return void 0!==d["delimiter characters"]&&(b.delimiterCharacters=d["delimiter characters"]),void 0!==d["non-edge characters"]&&(b.nonEdgeCharacters=d["non-edge characters"]),c},isNonEdgeCharacter:function(a){return b.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return b.delimiterCharacters.indexOf("ANY")>=0?1:b.delimiterCharacters.indexOf(a)>=0}};return b},d=function(a,b,c,d){return{init:function(e){a.on("mousedown",function(a){return a.shiftKey?!1:void 0}).on("mousedown",".textae-editor__type",function(){return!1}).on("mousedown",".textae-editor__body__text-box__paragraph-margin",function(a){return"textae-editor__body__text-box__paragraph-margin"===a.target.className?!1:void 0}),a.on("mouseup",".textae-editor__body,.textae-editor__span,.textae-editor__grid,.textae-editor__entity",c.event.editorSelected).on("mouseenter",".textae-editor__entity",function(){d.hoverRelation.on($(this).attr("title"))}).on("mouseleave",".textae-editor__entity",function(){d.hoverRelation.off($(this).attr("title"))}),b.bind("change",function(a){d.viewModel.buttonStateHelper.enabled("write",a.hasAnythingToSave),d.viewModel.buttonStateHelper.enabled("undo",a.hasAnythingToUndo),d.viewModel.buttonStateHelper.enabled("redo",a.hasAnythingToRedo),window.onbeforeunload=a.hasAnythingToSave?function(){return e}:null})}}},e=function(b){var c=$.extend(a("./util/getUrlParameters")(location.search),{config:b.attr("config"),target:b.attr("target")});!c.mode&&b.attr("mode")&&(c.mode=b.attr("mode"));var d=b.text();return b.empty(),c.annotation={inlineAnnotation:d,url:c.target},c},f=function(a,b){return a.typeContainer.setDefinedEntityTypes(b?b["entity types"]:[]),a.typeContainer.setDefinedRelationTypes(b?b["relation types"]:[]),b&&void 0!==b.css&&$("#css_area").html('<link rel="stylesheet" href="'+b.css+'"/>'),b},g=function(a,b,c){a[b]&&a[b](c)},h=function(b,c,d,e,f){return a("./component/DataAccessObject")(b,c).bind("save",function(){d.saved(),e.showFlashMessage("annotation saved")}).bind("save error",function(){e.showFlashMessage("could not save")}).bind("load",function(a){f(a.annotation),e.updateSoruceInfo(a.source)})};b.exports=function(){var b=a("./model/Model")(this),i=a("./model/History")(),j=new c,k=a("./model/Command")(this,b,i,j),l=a("./view/View")(this,b),m=a("./presenter/Presenter")(this,b,l,k,j),n=new d(this,i,m,l),o=_.partial(f,l),p=function(a){j.set(a),o(a)},q=function(a){return j.reset(),p(a.config),a.config?void 0:"no config"},r=function(a){b.annotationData.reset(a),i.reset()},s=function(b,c){j.reset(),"string"==typeof b?a("./util/ajaxAccessor").getAsync(b,function(a){p(a),r(c)},function(){alert("could not read the span configuration from the location you specified.")}):r(c)},t=function(a,b){var c=q(b);"no config"===c?s(a,b):r(b)},u=a("./component/StatusBar")(this),v=function(a,b){var c=a.annotation;c&&(c.inlineAnnotation?(t(a.config,JSON.parse(c.inlineAnnotation)),u.updateSoruceInfo("inline")):c.url&&b.getAnnotationFromServer(c.url))},w=function(a,b){m.setMode(a.mode),v(a,b)};return this.api=function(a){var c=function(c){var d=function(){c.showAccess(i.hasAnythingToSave())},e=function(){c.showSave(b.annotationData.toJson())},f={A:d,C:m.event.copyEntities,D:m.event.removeSelectedElements,DEL:m.event.removeSelectedElements,E:m.event.createEntity,Q:m.event.showPallet,R:m.event.replicate,S:e,V:m.event.pasteEntities,W:m.event.newLabel,X:k.redo,Y:k.redo,Z:k.undo,ESC:m.event.cancelSelect,LEFT:m.event.selectLeftSpan,RIGHT:m.event.selectRightSpan},h={"textae.control.button.read.click":d,"textae.control.button.write.click":e,"textae.control.button.undo.click":k.undo,"textae.control.button.redo.click":k.redo,"textae.control.button.replicate.click":m.event.replicate,"textae.control.button.replicate_auto.click":l.viewModel.modeAccordingToButton["replicate-auto"].toggle,"textae.control.button.relation_edit_mode.click":m.event.toggleRelationEditMode,"textae.control.button.entity.click":m.event.createEntity,"textae.control.button.change_label.click":m.event.newLabel,"textae.control.button.pallet.click":m.event.showPallet,"textae.control.button.negation.click":m.event.negation,"textae.control.button.speculation.click":m.event.speculation,"textae.control.button.delete.click":m.event.removeSelectedElements,"textae.control.button.copy.click":m.event.copyEntities,"textae.control.button.paste.click":m.event.pasteEntities,"textae.control.button.setting.click":m.event.showSettingDialog};a.api={handleKeyInput:_.partial(g,f),handleButtonClick:_.partial(g,h),redraw:function(){console.log(a.editorId,"redraw"),m.event.redraw()}}},d=function(a){var b="There is a change that has not been saved. If you procceed now, you will lose it.",d=e(a);l.init(),n.init(b),m.init();var f=h(a,b,i,u,_.partial(t,d.config));w(d,f),c(f)};return{start:d}}(this),this}},{"./component/DataAccessObject":10,"./component/StatusBar":12,"./model/Command":16,"./model/History":17,"./model/Model":19,"./presenter/Presenter":26,"./util/ajaxAccessor":37,"./util/getUrlParameters":46,"./view/View":56}],15:[function(a){var b=a("./tool"),c=a("./control"),d=a("./editor");jQuery.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return b.pushEditor(a),d.apply(a),a.api.start(a),a}),b.selectFirstEditor();else if(this.hasClass("textae-control")){var a=c(this);return b.setControl(a),a}}}()},{"./control":13,"./editor":14,"./tool":33}],16:[function(a,b){var c=function(a){a.forEach(function(a){a.execute()})},d=function(a){a.forEach(function(a){a.execute()})},e=function(a){return a=Object.create(a),a.reverse(),a.map(function(a){return a.revert()})},f=_.compose(c,e),g=function(a,b){b?console.log("[command.invoke]",a,b):console.log("[command.invoke]",a)},h=function(){var a=function(a,b){g(a+b.commandType+" a "+b.modelType+": "+b.id)},b=_.partial(a,""),c=_.partial(a,"revert "),d=function(a,b){var d={execute:function(){f(a),c(b)}};return function(){return d}},e=function(a,b,c,e,f){var g={modelType:a,commandType:c,id:e};return b.revert=new d(f,g),g};return _.compose(b,e)}(),i=function(a,b,c){a.selectionModel[b]&&a.selectionModel[b].add(c.id)};b.exports=function(b,e,j,k){var l=function(){var c=a("../util/IdFactory")(b),f=function(a,b,c,d){return{execute:function(){return d=a.annotationData[b].add(d),c&&i(a,b,d),this.revert=_.partial(l[b+"RemoveCommand"],d.id),g("create a new "+b+": ",d),d
}}},j=_.partial(f,e),m=function(a,b){return{execute:function(){var c=e.annotationData[a].remove(b);c?(this.revert=_.partial(j,a,!1,c),g("remove a "+a+": ",c)):(this.revert=function(){return{execute:function(){}}},g("already removed "+a+": ",b))}}},n=function(a,b,c){return{execute:function(){var d=e.annotationData[a].get(b).type,f=e.annotationData[a].changeType(b,c);this.revert=_.partial(l[a+"ChangeTypeCommand"],b,d),g("change type of a "+a+". oldtype:"+d+" "+a+":",f)}}},o=_.partial(h,"span"),p=_.partial(j,"span",!0),q=_.partial(j,"entity",!0),r=function(a,b){var e=c.makeSpanId(b),f=p(b),g=q({span:e,type:a}),h=[f,g];return{execute:function(){d(h),o(this,"create",e,h)}}},s=function(a,b){var c=_.partial(r,a),f=e.getReplicationSpans(b,k).map(c);return{execute:function(){d(f),o(this,"replicate",b.id,f)}}},t=_.partial(j,"relation",!1),u=_.partial(j,"relation",!0),v=_.partial(m,"modification"),w=_.partial(m,"relation"),x=function(a){var b=w(a),c=e.annotationData.getModificationOf(a).map(function(a){return a.id}).map(v),f=c.concat(b);return{execute:function(){d(f),h("relation",this,"remove",a,f)}}},y=_.partial(m,"entity"),z=function(a){var b=y(a),c=e.annotationData.entity.assosicatedRelations(a).map(w),f=e.annotationData.getModificationOf(a).map(function(a){return a.id}).map(v),g=c.concat(f).concat(b);return{execute:function(){d(g),h("entity",this,"remove",a,g)}}},A=function(a){var b=_.partial(m,"span")(a),c=_.flatten(e.annotationData.span.get(a).getTypes().map(function(a){return a.entities.map(function(a){return z(a)})})),f=c.concat(b);return{execute:function(){d(f),o(this,"remove",a,f)}}},B=function(a){var b=e.annotationData.span.get(e.annotationData.entity.get(a).span),c=_.reject(_.flatten(b.getTypes().map(function(a){return a.entities})),function(b){return b===a}).length;return 0===c?A(b.id):z(a)},C=(_.partial(n,"entity"),function(a,b,c){var f=_.partial(n,"entity")(a,b),g=c?e.annotationData.entity.assosicatedRelations(a).map(w).concat(f):[f];return{execute:function(){d(g),h("entity",this,"change",a,g)}}}),D=function(a,b){var f=[],g=c.makeSpanId(b),i=e.annotationData;return i.span.get(g)||(f.push(A(a)),f.push(p({begin:b.begin,end:b.end})),i.span.get(a).getTypes().forEach(function(a){a.entities.forEach(function(b){f.push(q({id:b,span:g,type:a.name})),f=f.concat(i.entity.assosicatedRelations(b).map(i.relation.get).map(t))})})),{execute:function(){d(f),h("span",this,"move",a,f)}}};return{spanCreateCommand:r,spanRemoveCommand:A,spanMoveCommand:D,spanReplicateCommand:s,entityCreateCommand:q,entityRemoveCommand:B,entityChangeTypeCommand:C,relationCreateCommand:u,relationRemoveCommand:x,relationChangeTypeCommand:_.partial(n,"relation"),modificationCreateCommand:_.partial(j,"modification",!1),modificationRemoveCommand:v}}();return{invoke:function(a){a&&a.length>0&&(c(a),j.push(a))},undo:function(){return function(){j.hasAnythingToUndo()&&(e.selectionModel.clear(),f(j.prev()))}}(),redo:function(){j.hasAnythingToRedo()&&(e.selectionModel.clear(),c(j.next()))},factory:l}}},{"../util/IdFactory":36}],17:[function(a,b){b.exports=function(){var b=-1,c=-1,d=[],e=function(){return c>-1},f=function(){return c<d.length-1},g=function(){return c!=b},h=function(){i.trigger("change",{hasAnythingToSave:g(),hasAnythingToUndo:e(),hasAnythingToRedo:f()})},i=a("../util/extendBindable")({reset:function(){b=-1,c=-1,d=[],h()},push:function(a){d.splice(c+1,d.length-c,a),c++,h()},next:function(){return c++,h(),d[c]},prev:function(){var a=d[c];return c--,h(),a},saved:function(){b=c,h()},hasAnythingToSave:g,hasAnythingToUndo:e,hasAnythingToRedo:f});return i}},{"../util/extendBindable":45}],18:[function(a,b){b.exports=function(b){var c=a("../util/extendBindable"),d={},e=function(){f.trigger(b+".change")},f=c({name:b,add:function(a){d[a]=a,f.trigger(b+".add",a),e()},all:function(){return _.toArray(d)},has:function(a){return _.contains(d,a)},some:function(){return _.some(d)},single:function(){var a=f.all();return 1===a.length?a[0]:null},toggle:function(a){f.has(a)?f.remove(a):f.add(a)},remove:function(a){delete d[a],f.trigger(b+".remove",a),e()},clear:function(){f.some()&&(_.each(f.all(),f.remove),d={},e())}});return f}},{"../util/extendBindable":45}],19:[function(a,b){var c=function(b,c){var d=a("../util/IdFactory")(b),e=function(a){return a=a||[],a.map(function(a){return{id:a.id,span:d.makeSpanId(a.span),type:a.obj}})},f=a("./ModelContainer")(c,"entity",e),g=_.extend(f,{add:_.compose(f.add,function(a){if(a.span)return a;throw new Error("entity has no span! "+JSON.stringify(a))}),assosicatedRelations:function(a){return c.relation.all().filter(function(b){return b.obj===a||b.subj===a}).map(function(a){return a.id})}});return g},d=function(b){var d,e=a("../util/extendBindable"),f=e({}),g=_.partial(a("./ModelContainer"),f),h=a("./ParagraphContainer")(b,f),i=a("./SpanContainer")(b,f,h),j=new c(b,f),k=new g("relation",function(a){return a=a||[],a.map(function(a){return{id:a.id,type:a.pred,subj:a.subj,obj:a.obj}})}),l=new g("modification",_.identity);return _.extend(f,{span:i,entity:j,relation:k,modification:l,paragraph:h,sourceDoc:"",reset:function(){var a=function(a){return d=a,a},b=function(a,b){var c=b.text;if(!c)throw"read failed.";return a.sourceDoc=c,h.setSource(c),f.trigger("change-text",{sourceDoc:c,paragraphs:h.all()}),b},c=function(a,b){var c=b.denotations;return a.span.setSource(c),a.entity.setSource(c),b},e=function(a,b){return a.relation.setSource(b.relations),b},g=function(a,b){return a.modification.setSource(b.modifications),b},i=function(a,b){return a.config=b.config,b};return function(d){var h=_.compose(_.partial(i,this),_.partial(g,this),_.partial(e,this),_.partial(c,this),_.partial(b,this),a);try{h(d),f.trigger("all.change",f)}catch(j){throw alert(j),j}}}(),toJson:function(){var a=j.all().filter(function(a){return i.get(a.span)}).map(function(a){var b=i.get(a.span);return{id:a.id,span:{begin:b.begin,end:b.end},obj:a.type}});return JSON.stringify($.extend(d,{denotations:a,relations:k.all().map(function(a){return{id:a.id,pred:a.type,subj:a.subj,obj:a.obj}}),modifications:l.all()}))},isBoundaryCrossingWithOtherSpans:_.partial(a("./isBoundaryCrossingWithOtherSpans"),i.all),getModificationOf:function(a){return l.all().filter(function(b){return b.obj===a})}})};b.exports=function(b){var c=new d(b),e=function(a,b,c){var d=function(b){for(var c=String.prototype.indexOf.bind(a.sourceDoc,a.sourceDoc.substring(b.begin,b.end)),d=b.end-b.begin,e=[],f=0,g=c(f);-1!==g;g=c(f))e.push({begin:g,end:g+d}),f=g+d;return e},e=function(a){return a.begin===b.begin},f=function(b){var d=a.sourceDoc.charAt(b.begin-1),e=a.sourceDoc.charAt(b.end);return c.isDelimiter(d)&&c.isDelimiter(e)},g=function(b){return a.span.all().filter(function(a){return a.begin===b.begin&&a.end===b.end}).length>0};return d(b).filter(function(b){return!e(b)&&f(b)&&!g(b)&&!a.isBoundaryCrossingWithOtherSpans(b)})};return{annotationData:c,selectionModel:a("./Selection")(["span","entity","relation"]),getReplicationSpans:_.partial(e,c)}}},{"../util/IdFactory":36,"../util/extendBindable":45,"./ModelContainer":20,"./ParagraphContainer":21,"./Selection":22,"./SpanContainer":23,"./isBoundaryCrossingWithOtherSpans":24}],20:[function(a,b){var c=function(a,b){var c=b().filter(function(b){return b[0]===a}).map(function(a){return a.slice(1)});return a+(0===c.length?1:Math.max.apply(null,c)+1)};b.exports=function(a,b,d){var e={},f=function(){return Object.keys(e)},g=_.partial(c,b?b.charAt(0).toUpperCase():"",f),h=function(a){return a.id=a.id||g(),e[a.id]=a,a},i=function(a){a&&a.forEach(h)},j=function(a){return e[a]},k=function(){return _.map(e,_.identity)},l=function(){e={}};return{name:b,setSource:function(a){if(!_.isFunction(d))throw new Error('Set the mappingFunction by the constructor to use the method "ModelContainer.setSource".');l(),i(d(a))},add:function(c,d){var e=h(c);return _.isFunction(d)&&d(),a.trigger(b+".add",e)},get:j,all:k,some:function(){return _.some(e)},types:function(){return k().map(function(a){return a.type})},changeType:function(c,d){var e=j(c);return e.type=d,a.trigger(b+".change",e),e},remove:function(c){var d=e[c];return d&&(delete e[c],a.trigger(b+".remove",d)),d},clear:l}}},{}],21:[function(a,b){b.exports=function(b,c){var d=a("../util/IdFactory")(b),e=function(a){a=a||[];var b=0;return a.split("\n").map(function(a,c){var e={id:d.makeParagraphId(c),begin:b,end:b+a.length};return b+=a.length+1,e})},f=a("./ModelContainer")(c,"paragraph",e),g=_.extend(f,{getBelongingTo:function(a){var b=f.all().filter(function(b){return a.begin>=b.begin&&a.end<=b.end});if(0===b.length)throw new Error("span should belong to any paragraph.");return b[0]}});return g}},{"../util/IdFactory":36,"./ModelContainer":20}],22:[function(a,b){var c=function(a){_.each(a,function(a){a.clear()})},d=function(a){return a.map(function(a){return a.some()}).reduce(function(a,b){return a||b})},e=function(a){_.each(a,function(b){b.bind(b.name+".change",function(){a.trigger(b.name+".change")}).bind(b.name+".add",function(c){a.trigger(b.name+".select",c)}).bind(b.name+".remove",function(c){a.trigger(b.name+".deselect",c)})})},f=function(a,b){return _.extend(b,{clear:_.partial(c,a),some:_.partial(d,a)})};b.exports=function(b){var c=b.map(a("./IdContainer")),d=a("../util/extendBindable")(c.reduce(function(a,b){return a[b.name]=b,a},{}));return e(d),f(c,d)}},{"../util/extendBindable":45,"./IdContainer":18}],23:[function(a,b){b.exports=function(b,c,d){var e=a("../util/IdFactory")(b),f=function(){var a={isChildOf:function(a){if(!a)return!1;var b=e.makeSpanId(a);if(!i.get(b))throw new Error("maybeParent is removed. "+a.toStringOnlyThis());return a.begin<=this.begin&&this.end<=a.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+c.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children&&this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=j.indexOf(this),0===a||j[a-1].paragraph!==this.paragraph?null:j[a-1])},getTypes:function(){var a=this.id;return c.entity.all().filter(function(b){return a===b.span}).reduce(function(a,b){var c=e.makeTypeId(b.span,b.type),d=a.filter(function(a){return a.id===c});return d.length>0?d[0].entities.push(b.id):a.push({id:c,name:b.type,entities:[b.id]}),a},[])},getEntities:function(){return _.flatten(this.getTypes().map(function(a){return a.entities}))}};return function(b){return $.extend({},b,{id:e.makeSpanId(b),paragraph:d.getBelongingTo(b)},a)}}(),g=a("./isBoundaryCrossingWithOtherSpans"),h=function(a){return a=a||[],a.map(function(a){return a.span}).map(f).filter(function(a,b,c){return!g(function(){return c.slice(0,b-1)},a)})},i=a("./ModelContainer")(c,"span",h),j=[],k=function(a,b){a.children.push(b),b.parent=a},l=function(a,b){return b.isChildOf(a)?a:a.parent?l(a.parent,b):null},m=function(){var a=i.all().sort(n),b=[];a.map(function(a,b,c){return $.extend(a,{parent:null,children:[],left:0!==b?c[b-1]:null,right:b!==c.length-1?c[b+1]:null})}).forEach(function(a){if(a.left){var c=l(a.left,a);c?k(c,a):b.push(a)}else b.push(a)}),b.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},j=b},n=function(a,b){return a.begin-b.begin||b.end-a.end},o={add:function(a){if(a)return i.add(f(a),m);throw new Error("span is undefined.")},setSource:function(a){i.setSource(a),m()},get:function(a){return i.get(a)},all:i.all,range:function(a,b){var c=i.get(a),d=i.get(b);if(n(c,d)>0){var e=c;c=d,d=e}return i.all().filter(function(a){return c.begin<=a.begin&&a.end<=d.end}).map(function(a){return a.id})},topLevel:function(){return j},multiEntities:function(){return i.all().filter(function(a){var b=a.getTypes().filter(function(a){return a.entities.length>1});return b.length>0})},remove:i.remove,clear:function(){i.clear(),j=[]}};return o}},{"../util/IdFactory":36,"./ModelContainer":20,"./isBoundaryCrossingWithOtherSpans":24}],24:[function(a,b){b.exports=function(a,b){return a().filter(function(a){return a.begin<b.begin&&b.begin<a.end&&a.end<b.end||b.begin<a.begin&&a.begin<b.end&&b.end<a.end}).length>0}},{}],25:[function(a,b){var c=function(){var b={instanceHide:0,instanceShow:2},d=function(a,b){return c[a]=b,b},e=_.extend({},b),f=a("../util/capitalize");return _.each(b,function(a,b){e["set"+f(b)]=_.partial(d,b)}),e}();b.exports=function(a,b,d){var e={init:function(){b.changeTypeGap(-1),_.extend(e,k.init)},get typeGap(){return b.getTypeGapValue()},get lineHeight(){return Math.floor(b.getLineHeight())},changeLineHeight:b.changeLineHeight},f=function(){d.hideDialogs(),a.selectionModel.clear()},g={toTerm:function(){f(),d.editEntity(),b.setTerm(),b.setEditable(!0),b.changeTypeGap(c.instanceHide),_.extend(e,k.termCentric)},toInstance:function(){f(),d.editEntity(),b.setInstance(),b.setEditable(!0),b.changeTypeGap(c.instanceShow),_.extend(e,k.instanceRelation)},toRelation:function(){f(),d.editRelation(),b.setRelation(),b.setEditable(!0),b.changeTypeGap(c.instanceShow),_.extend(e,k.relationEdit)},toViewTerm:function(){f(),d.noEdit(),b.setTerm(),b.setEditable(!1),b.changeTypeGap(c.instanceHide),_.extend(e,k.viewTerm)},toViewInstance:function(){f(),d.noEdit(),b.setInstance(),b.setEditable(!1),b.changeTypeGap(c.instanceShow),_.extend(e,k.viewInstance)}},h=function(){console.log("no mode transition.",this.name)},i=_.compose(b.changeTypeGap,c.setInstanceHide),j=_.compose(b.changeTypeGap,c.setInstanceShow),k={init:_.extend({},g,{name:"Init"}),termCentric:_.extend({},g,{name:"Term Centric",toTerm:h,changeTypeGap:i,showInstance:!1}),instanceRelation:_.extend({},g,{name:"Instance / Relation",toInstance:h,changeTypeGap:j,showInstance:!0}),relationEdit:_.extend({},g,{name:"Relation Edit",toRelation:h,changeTypeGap:j,showInstance:!0}),viewTerm:_.extend({},g,{name:"View Only",toTerm:h,toInstance:g.toViewInstance,toRelation:h,toViewTerm:h,changeTypeGap:i,showInstance:!1}),viewInstance:_.extend({},g,{name:"View Only",toTerm:g.toViewTerm,toInstance:h,toRelation:h,toViewInstance:h,changeTypeGap:j,showInstance:!0})};return e}},{"../util/capitalize":38}],26:[function(a,b){b.exports=function(b,c,d,e,f){var g=function(){i.viewHandler.hideDialogs(),b.tool.selectMe(),d.viewModel.buttonStateHelper.propagate()},h=a("./TypeEditor")(b,c,f,e,d.viewModel,d.typeContainer),i=function(){var f=function(){var a=function(a){var b,f=function(b){return b.pred===a},g=function(a){return c.annotationData.getModificationOf(a).filter(f)},i=d.viewModel.modeAccordingToButton[a.toLowerCase()].value();b=i?h.getSelectedIdEditable().map(function(a){var b=g(a)[0];return e.factory.modificationRemoveCommand(b.id)}):_.reject(h.getSelectedIdEditable(),function(a){return g(a).length>0}).map(function(b){return e.factory.modificationCreateCommand({obj:b,pred:a})}),e.invoke(b)};return{replicate:function(){var a=c.selectionModel.span.single();a?e.invoke([e.factory.spanReplicateCommand(d.typeContainer.entity.getDefaultType(),c.annotationData.span.get(a))]):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=c.selectionModel.span.all().map(function(a){return e.factory.entityCreateCommand({span:a,type:d.typeContainer.entity.getDefaultType()})});e.invoke(a)},newLabel:function(){if(c.selectionModel.entity.some()||c.selectionModel.relation.some()){var a=prompt("Please enter a new label","");a&&h.setNewType(a)}},negation:_.partial(a,"Negation"),speculation:_.partial(a,"Speculation"),removeSelectedElements:function(){var a=function(){var a=[],b=[],c=[];return{addSpanId:function(b){a.push(b)},addEntityId:function(a){b.push(a)},addRelations:function(a){c=c.concat(a)},getAll:function(){return _.uniq(c).map(e.factory.relationRemoveCommand).concat(_.uniq(b).map(function(a){return e.factory.entityRemoveCommand(a)}),_.uniq(a).map(e.factory.spanRemoveCommand))}}}();c.selectionModel.span.all().forEach(function(b){a.addSpanId(b)}),c.selectionModel.entity.all().forEach(function(b){a.addEntityId(b)}),a.addRelations(c.selectionModel.relation.all()),e.invoke(a.getAll())},copyEntities:function(){d.clipBoard.clipBoard=_.uniq(function(){return _.flatten(c.selectionModel.span.all().map(function(a){return c.annotationData.span.get(a).getEntities()}))}().concat(c.selectionModel.entity.all())).map(function(a){return c.annotationData.entity.get(a).type})},pasteEntities:function(){var a=_.flatten(c.selectionModel.span.all().map(function(a){return d.clipBoard.clipBoard.map(function(b){return e.factory.entityCreateCommand({span:a,type:b})})}));e.invoke(a)}}}(),g=function(){var e=a("./EditMode")(c,d.viewMode,h),f=function(a){e["to"+a]&&e["to"+a]()};return{showPallet:h.showPallet,hideDialogs:h.hideDialogs,cancelSelect:h.cancelSelect,selectLeftSpan:function(){var a=c.selectionModel.span.single();if(a){var b=c.annotationData.span.get(a);c.selectionModel.clear(),b.left&&c.selectionModel.span.add(b.left.id)}},selectRightSpan:function(){var a=c.selectionModel.span.single();if(a){var b=c.annotationData.span.get(a);c.selectionModel.clear(),b.right&&c.selectionModel.span.add(b.right.id)}},showSettingDialog:a("./SettingDialog")(b,e),toggleRelationEditMode:function(){d.viewModel.modeAccordingToButton["relation-edit-mode"].value()?e.toInstance():e.toRelation()},bindChangeViewMode:function(){var a=function(a){e.init(),f(c.annotationData.relation.some()||c.annotationData.span.multiEntities().length>0?a+"Instance":a+"Term")};return function(b){var d="edit"===b?"":"View";c.annotationData.bind("all.change",_.partial(a,d))}}()}}();return{editHandler:f,viewHandler:g}}();return{init:function(){b.on("textae.editor.jsPlumbConnection.add",function(a,b){b.bindClickAction(h.jsPlumbConnectionClicked)});var c=a("../util/CursorChanger")(b);d.bind("render.start",function(a){console.log(a.editorId,"render.start"),c.startWait()}).bind("render.end",function(a){console.log(a.editorId,"render.end"),c.endWait()})},setMode:i.viewHandler.bindChangeViewMode,event:{editorSelected:g,redraw:d.updateDisplay,copyEntities:i.editHandler.copyEntities,removeSelectedElements:i.editHandler.removeSelectedElements,createEntity:i.editHandler.createEntity,showPallet:i.viewHandler.showPallet,replicate:i.editHandler.replicate,pasteEntities:i.editHandler.pasteEntities,newLabel:i.editHandler.newLabel,cancelSelect:i.viewHandler.cancelSelect,selectLeftSpan:i.viewHandler.selectLeftSpan,selectRightSpan:i.viewHandler.selectRightSpan,toggleRelationEditMode:i.viewHandler.toggleRelationEditMode,negation:i.editHandler.negation,speculation:i.editHandler.speculation,showSettingDialog:i.viewHandler.showSettingDialog}}}},{"../util/CursorChanger":34,"./EditMode":25,"./SettingDialog":28,"./TypeEditor":31}],27:[function(a,b){b.exports=function(b,c,d,e,f,g){var h=function(b,c,d){var e=a("./SpanAdjuster")(d,c.annotationData),f=a("../util/DomUtil")(b),g=function(a){var b=e.toPositions(a),f=c.annotationData.sourceDoc.substring(b.anchorPosition,b.focusPosition);return d.nonEdgeCharacters.forEach(function(a){f=f.replace(a,"")}),f.length>0},h=function(a){return a.anchorNode.parentElement.id===a.focusNode.parentElement.id},i=function(a){return $(a.anchorNode.parentNode)},j=function(a){return $(a.focusNode.parentNode)},k=function(a){return a.hasClass("textae-editor__span")},l=function(a){return a.hasClass("textae-editor__body__text-box__paragraph")},m=function(a){return k(a)||l(a)},n=_.compose(k,i),o=_.compose(k,j),p=_.compose(l,j),q=_.compose(m,i),r=function(){var a=function(b){return l(b)?b:a(b.parent())},b=function(b,c){var d=$(b[c+"Node"].parentNode);return a(d).attr("id")};return function(a){var c=b(a,"anchor"),d=b(a,"focus");return c===d}}(),s=function(a){return a.anchorNode.parentNode.parentNode===a.focusNode.parentNode},t=function(a){return a.anchorNode.parentNode===a.focusNode.parentNode.parentNode},u=function(a){var b=c.selectionModel.span.single();if(b){var d=c.annotationData.span.get(b);return d.begin<a&&a<d.end}return!1},v=function(a){return u(e.getAnchorPosition(a))},w=function(a){return a.focusNode.parentNode.id===c.selectionModel.span.single()},x=function(a){return u(e.getFocusPosition(a))},y=function(a){var b=c.selectionModel.span.single();return f.selector.span.get(b).parent().attr("id")===a.focusNode.parentNode.id},z=function(a){var b=i(a),d=e.getFocusPosition(a);if(k(b)&&b.parent()&&k(b.parent())){var f=c.annotationData.span.get(b.parent().attr("id"));if(d<f.begin||f.end<d)return!0}},A=function(a){var b=j(a),d=e.getAnchorPosition(a);if(k(b)&&b.parent()&&k(b.parent())){var f=c.annotationData.span.get(b.parent().attr("id"));if(d<f.begin||f.end<d)return!0}};return{hasCharacters:g,isInOneParent:h,isAnchrNodeInSpan:n,isAnchrNodeInSpanOrParagraph:q,isFocusNodeInSpan:o,isFocusNodeInParagraph:p,isInSameParagraph:r,isAnchorOneDownUnderForcus:s,isForcusOneDownUnderAnchor:t,isAnchorInSelectedSpan:v,isFocusOnSelectedSpan:w,isFocusInSelectedSpan:x,isSelectedSpanOneDownUnderFocus:y,isLongerThanParentSpan:z,isShorterThanChildSpan:A}}(b,c,d),i=a("./dismissBrowserSelection"),j=function(a){var b=function(){alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again."),i()},c=function(a,b,c){return c&&!b(c)?a():c},d=_.partial(c,i),e=_.partial(d,a.isAnchrNodeInSpanOrParagraph),f=_.partial(d,a.isFocusNodeInParagraph),g=_.partial(d,a.isFocusNodeInSpan),h=_.partial(c,b,a.isInSameParagraph),j=_.partial(d,a.hasCharacters),k=_.partial(_.compose,j,h,e),l=k(f),m=k(g);return{validateOnText:l,validateOnSpan:m}}(h),k=function(b,c,d,e,f,g,h){var k=a("./SpanManipulater")(d,c),l=a("../util/IdFactory")(b),m=function(a,b){return a!==l.makeSpanId(b)?[f.factory.spanMoveCommand(a,b)]:void 0},n=function(a){return[f.factory.spanRemoveCommand(a)]},o=function(a){var b=100,d=k.create(a);if(c.annotationData.isBoundaryCrossingWithOtherSpans({begin:d.begin,end:d.end}))return void i();var e=l.makeSpanId(d);if(c.annotationData.span.get(e))return void i();var j=[f.factory.spanCreateCommand(h.entity.getDefaultType(),{begin:d.begin,end:d.end})];g.modeAccordingToButton["replicate-auto"].value()&&d.end-d.begin<=b&&j.push(f.factory.spanReplicateCommand(h.entity.getDefaultType(),{begin:d.begin,end:d.end})),f.invoke(j),i()},p=function(){var a=function(a,b){var d=k.expand(a,b);return c.annotationData.isBoundaryCrossingWithOtherSpans({begin:d.begin,end:d.end})?(alert("A span cannot be expanded to make a boundary crossing."),void i()):(f.invoke(m(a,d)),void i())};return function(b){return e.isAnchorInSelectedSpan(b)?a(c.selectionModel.span.single(),b):e.isAnchorOneDownUnderForcus(b)&&a(b.anchorNode.parentNode.id,b),b}}(),q=function(){var a=function(a,b){var d=k.shrink(a,b);if(c.annotationData.isBoundaryCrossingWithOtherSpans({begin:d.begin,end:d.end}))return alert("A span cannot be shrinked to make a boundary crossing."),void i();var e=l.makeSpanId(d),g=c.annotationData.span.get(e);f.invoke(d.begin<d.end&&!g?m(a,d):n(a)),i()};return function(b){return e.isFocusInSelectedSpan(b)?a(c.selectionModel.span.single(),b):e.isForcusOneDownUnderAnchor(b)&&a(b.focusNode.parentNode.id,b),b}}(),r=function(a,b,c){return c&&b(c)?a(c):c},s=_.partial(r,o,e.isInOneParent),t=_.partial(r,p,e.isAnchrNodeInSpan),u=_.partial(r,q,e.isFocusNodeInSpan),v=_.partial(r,i,function(){return!0}),w=_.compose(v,t,s,j.validateOnText),x=_.compose(v,u,t,s,j.validateOnSpan);return{selectEndOfText:w,selectEndOnSpan:x}}(b,c,d,h,e,f,g);return{onText:k.selectEndOfText,onSpan:k.selectEndOnSpan}}},{"../util/DomUtil":35,"../util/IdFactory":36,"./SpanAdjuster":29,"./SpanManipulater":30,"./dismissBrowserSelection":32}],28:[function(a,b){var c=function(a){return _.debounce(a,300)},d=function(a){return 16*a},e=function(){$(window).trigger("resize")},f=function(){return h.Div("textae-editor__setting-dialog")},g=function(a){return a.open()},h=a("../util/jQuerySugar"),i=function(a,b){return h.setChecked(b,".mode",a.showInstance?"checked":null)},j=function(a,b){return h.setValue(b,".line-height",a.lineHeight)},k=function(a,b){return h.setValue(b,".type-gap",a.typeGap)},l=function(a){return a.find(".type-gap")},m=function(a,b){return h.enabled(l(b),a.showInstance),b},n=function(a,b,c){c?a.toInstance():a.toTerm(),m(a,b),k(a,b),j(a,b)},o=_.partial(h.Label,"textae-editor__setting-dialog__label");b.exports=function(b,l){var p=function(a){var b=c(function(){n(l,a,$(this).is(":checked"))});return a.append(h.Div().append(new o("Instance/Relation View")).append(h.Checkbox("textae-editor__setting-dialog__term-centric-view mode"))).on("click",".mode",b)},q=function(a){var b=c(function(){l.changeTypeGap($(this).val()),j(l,a)});return a.append(h.Div().append(new o("Type Gap")).append(h.Number("textae-editor__setting-dialog__type-gap type-gap").attr({step:1,min:0,max:5}))).on("change",".type-gap",b)},r=function(a){var b=_.compose(e,l.changeLineHeight,d),f=c(function(){b($(this).val())});return a.append(h.Div().append(new o("Line Height")).append(h.Number("textae-editor__setting-dialog__line-height line-height").attr({step:1,min:3,max:50}))).on("change",".line-height",f)},s=function(c){return a("../util/dialog/GetEditorDialog")(b)("textae.dialog.setting","Setting",c,!0)},t=function(a){return _.partial(a,l)};return _.compose(g,t(j),t(k),t(m),t(i),s,r,q,p,f)}},{"../util/dialog/GetEditorDialog":42,"../util/jQuerySugar":48}],29:[function(a,b){b.exports=function(a,b){var c=function(a){var c,d=$(a).parent(),e=d.attr("id");if(d.hasClass("textae-editor__body__text-box__paragraph"))c=b.paragraph.get(e).begin;else{if(!d.hasClass("textae-editor__span"))throw new Error("Can not get position of a node : "+a);c=b.span.get(e).begin}for(var f=a.parentElement.childNodes,g=0;f[g]!=a;g++)c+="#text"==f[g].nodeName?f[g].nodeValue.length:$("#"+f[g].id).text().length;return c},d=function(a){var b=c(a.focusNode);return b+=a.focusOffset},e=function(a){var b=c(a.anchorNode);return b+a.anchorOffset},f=function(c){for(var d=c;a.isNonEdgeCharacter(b.sourceDoc.charAt(d));)d++;for(;d>0&&!a.isDelimiter(b.sourceDoc.charAt(d))&&!a.isDelimiter(b.sourceDoc.charAt(d-1));)d--;return d},g=function(c){for(var d=c;a.isNonEdgeCharacter(b.sourceDoc.charAt(d-1));)d--;for(;!a.isDelimiter(b.sourceDoc.charAt(d))&&d<b.sourceDoc.length;)d++;return d},h=function(c){for(var d=c;d<b.sourceDoc.length&&(a.isNonEdgeCharacter(b.sourceDoc.charAt(d))||!a.isDelimiter(b.sourceDoc.charAt(d-1)));)d++;return d},i=function(c){for(var d=c;d>0&&(a.isNonEdgeCharacter(b.sourceDoc.charAt(d-1))||!a.isDelimiter(b.sourceDoc.charAt(d)));)d--;return d},j=function(a){var b=e(a),c=d(a);if(b>c){var f=b;b=c,c=f}return{anchorPosition:b,focusPosition:c}};return{toPositions:j,getAnchorPosition:e,getFocusPosition:d,adjustSpanBeginLong:f,adjustSpanEndLong:g,adjustSpanBeginShort:h,adjustSpanEndShort:i}}},{}],30:[function(a,b){b.exports=function(b,c){var d=a("./SpanAdjuster")(b,c.annotationData),e=function(){var a=function(a){var b=d.toPositions(a);return{begin:d.adjustSpanBeginLong(b.anchorPosition),end:d.adjustSpanEndLong(b.focusPosition)}};return function(b){return c.selectionModel.clear(),a(b)}}(),f=function(){var a=function(a,b,e,f){var g=c.annotationData.span.get(a);return b.compareBoundaryPoints(Range.START_TO_START,e)<0?{begin:d.adjustSpanBeginLong(f),end:g.end}:{begin:g.begin,end:d.adjustSpanEndLong(f)}};return function(b,e){c.selectionModel.clear();var f=e.getRangeAt(0),g=document.createRange();g.selectNode(e.anchorNode);var h=d.getFocusPosition(e);return a(b,f,g,h)}}(),g=function(){var a=function(a,b,e,f){var g=c.annotationData.span.get(a);return b.compareBoundaryPoints(Range.START_TO_START,e)>0?{begin:g.begin,end:d.adjustSpanEndShort(f)}:{begin:d.adjustSpanBeginShort(f),end:g.end}};return function(b,e){c.selectionModel.clear();var f=e.getRangeAt(0),g=document.createRange();g.selectNode(e.focusNode);var h=d.getFocusPosition(e);return a(b,f,g,h)}}();return{create:e,expand:f,shrink:g}}},{"./SpanAdjuster":29}],31:[function(a,b){b.exports=function(b,c,d,e,f,g){var h,i,j=a("./dismissBrowserSelection"),k={},l=a("../component/Pallet")(),m=function(){l.hide()},n=function(){m(),c.selectionModel.clear(),j()},o=function(a,b,c){var d=a();if(d.length>0){var f=d.map(function(a){return b(a,c)});e.invoke(f)}},p=function(){return b.off("mouseup",".textae-editor__body").off("mouseup",".textae-editor__span").off("mouseup",".textae-editor__span_block").off("mouseup",".textae-editor__type-label").off("mouseup",".textae-editor__entity-pane").off("mouseup",".textae-editor__entity")},q=function(){var a=function(a){if(c.selectionModel.entity.some()){var b=c.selectionModel.entity.all()[0],d=$(a.target).attr("title");b===d?c.selectionModel.entity.remove(b):(c.selectionModel.entity.add(d),_.defer(function(){if(e.invoke([e.factory.relationCreateCommand({subj:b,obj:d,type:g.relation.getDefaultType()})]),a.ctrlKey||a.metaKey)c.selectionModel.entity.remove(d);else{if(a.shiftKey)return j(),c.selectionModel.entity.remove(b),c.selectionModel.entity.add(d),!1;c.selectionModel.entity.remove(b),c.selectionModel.entity.remove(d)}}))}else c.selectionModel.clear(),c.selectionModel.entity.add($(a.target).attr("title"));return!1},b=function(a,b){var d=a.getParameter("id");b.ctrlKey||b.metaKey?c.selectionModel.relation.toggle(d):c.selectionModel.relation.single()!==d&&(c.selectionModel.clear(),c.selectionModel.relation.add(d))},d=function(){return!1};return function(){p().on("mouseup",".textae-editor__entity",a).on("mouseup",".textae-editor__relation, .textae-editor__relation__label",d).on("mouseup",".textae-editor__body",n),k.typeContainer=g.relation,i=c.selectionModel.relation.all,h=_.partial(o,i,e.factory.relationChangeTypeCommand),t=b}}(),r=function(){var j=a("./SelectEnd")(b,c,d,e,f,g),l=function(){var a=window.getSelection();a.isCollapsed?n():j.onText(a)},m=function(){var a=function(a){return _.flatten(c.annotationData.span.get(a).getTypes().filter(function(a){return g.entity.isBlock(a.name)}).map(function(a){return a.entities}))},d=function(d,e){c.selectionModel.span[d](e),b.find("#"+e).hasClass("textae-editor__span--block")&&a(e).forEach(c.selectionModel.entity[d])},e=_.partial(d,"add"),f=_.partial(d,"toggle");return function(a){var b=c.selectionModel.span.single(),d=a.target,g=d.id;a.shiftKey&&b?(c.selectionModel.clear(),c.annotationData.span.range(b,g).forEach(function(a){e(a)})):a.ctrlKey||a.metaKey?f(g):(c.selectionModel.clear(),e(g))}}(),q=function(a){var b=window.getSelection();return b.isCollapsed?(m(a),!1):(j.onSpan(b),void a.stopPropagation())},r=function(a,b,d){var e=function(a){a.each(function(){c.selectionModel.entity.add($(this).attr("title"))})},f=function(a){a.each(function(){c.selectionModel.entity.remove($(this).attr("title"))})};return a?b.hasClass("ui-selected")?f(d):e(d):(c.selectionModel.clear(),e(d)),!1},s=function(a){var b=$(a.target);return r(a.ctrlKey||a.metaKey,b,b.next().children())},u=function(a){var b=$(a.target);return a.ctrlKey||a.metaKey?c.selectionModel.entity.toggle(b.attr("title")):(c.selectionModel.clear(),c.selectionModel.entity.add(b.attr("title"))),!1},v=function(a){var b=$(a.target);return r(a.ctrlKey||a.metaKey,b.prev(),b.children())},w=function(a,b){return e.factory.entityChangeTypeCommand(a,b,g.entity.isBlock(b))};return function(){p().on("mouseup",".textae-editor__body",l).on("mouseup",".textae-editor__span",q).on("mouseup",".textae-editor__type-label",s).on("mouseup",".textae-editor__entity-pane",v).on("mouseup",".textae-editor__entity",u),k.typeContainer=g.entity,i=c.selectionModel.entity.all,h=_.partial(o,i,w),t=null}}(),s=function(){p(),k.typeContainer=null,h=null,i=null,t=null};l.bind("type.select",function(a){l.hide(),h(a)}).bind("default-type.select",function(a){l.hide(),k.typeContainer.setDefaultType(a)});var t=null,u=function(){return function(a,b){t&&!b.processedByTextae&&t(a,b),b.processedByTextae=!0}}();return{editRelation:q,editEntity:r,noEdit:s,showPallet:function(a){l.show(k,a)},setNewType:function(a){h(a)},hideDialogs:m,cancelSelect:n,jsPlumbConnectionClicked:u,getSelectedIdEditable:function(){return i&&i()}}}},{"../component/Pallet":11,"./SelectEnd":27,"./dismissBrowserSelection":32}],32:[function(a,b){b.exports=function(){var a=window.getSelection();
a.collapse(document.body,0)}},{}],33:[function(a,b){b.exports=function(){{var b=function(){var b=a("./util/dialog/GetToolDialog"),c=new b("textae-control__help","Help (Keyboard short-cuts)",{height:315,width:438},$("<div>").addClass("textae-tool__key-help")),d=new b("textae-control__about","About TextAE (Text Annotation Editor)",{height:500,width:600},$("<div>").html("<p>今ご覧になっているTextAEはPubAnnotationで管理しているアノテーションのビューアもしくはエディタです。</p><p>PubAnnotationではPubMedのアブストラクトにアノテーションを付けることができます。</p><p>現在はEntrez Gene IDによる自動アノテーションおよびそのマニュアル修正作業が可能となっています。今後は自動アノテーションの種類を増やす計画です。</p><p>間違ったアノテーションも目に付くと思いますが、それを簡単に直して自分のプロジェクトにセーブできるのがポイントです。</p><p>自分のアノテーションを作成するためにはPubAnnotation上で自分のプロジェクトを作る必要があります。作成したアノテーションは後で纏めてダウンロードしたり共有することができます。</p><p>まだ開発中のサービスであり、実装すべき機能が残っています。ユーザの皆様の声を大事にして開発していきたいと考えておりますので、ご意見などございましたら教えていただければ幸いです。</p>")),e=function(a,b){var c="textae-editor--active";_.reject(a,function(a){return a===b}).forEach(function(a){a.removeClass(c),console.log("deactive",a.editorId)}),b.addClass(c),console.log("active",b.editorId)};return{control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){e(this,a),this.selected=a},selectFirst:function(){this.select(this[0])},selected:null}),openDialog:{help:c.open,about:d.open}}}(),c=function(){var a={},b=function(b){a={top:b.clientY,left:b.clientX}},c=_.debounce(b,30);return $("html").on("mousemove",c),function(){return a}}(),d={handleKeyInput:function(a){"H"===a?b.openDialog.help():b.editors.selected&&b.editors.selected.api.handleKeyInput(a,c())},handleButtonClick:function(a){switch(a){case"textae.control.button.help.click":b.openDialog.help();break;case"textae.control.button.about.click":b.openDialog.about();break;default:b.editors.selected&&b.editors.selected.api.handleButtonClick(a,c())}},handleEditor:{select:function(a){b.editors.select(a)},"public":{changeButtonState:function(a,c){b.control&&a===b.editors.selected&&b.control.updateAllButtonEnableState(c)},push:function(a,c){b.control&&b.control.updateButtonPushState(a,c)}}}};!function(){var a=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},c=function(a){return a.keyCode},e=_.compose(d.handleKeyInput,b,c),f=e;$(document).on("keyup",function(a){f(a)}),$("body").on("dialogopen",".ui-dialog",function(){f=function(){}}).on("dialogclose",".ui-dialog",function(){f=e})},c=function(){$(window).on("resize",_.debounce(function(){b.editors.forEach(function(a){console.log(a.editorId,"redraw"),_.defer(a.api.redraw)})},500))};$(_.compose(c,a))}()}return{setControl:function(a){a.on("textae.control.button.click",function(){d.handleButtonClick.apply(null,_.rest(arguments))}),b.control=a},pushEditor:function(a){b.editors.push(a),$.extend(a,{editorId:b.editors.getNewId(),tool:$.extend({selectMe:_.partial(d.handleEditor.select,a)},d.handleEditor.public)})},selectFirstEditor:function(){b.editors.selectFirst()}}}()},{"./util/dialog/GetToolDialog":43}],34:[function(a,b){var c=function(a,b){a=a.add(".ui-dialog, .ui-widget-overlay"),a[b+"Class"]("textae-editor--wait")};b.exports=function(a){var b=_.partial(c,a,"add"),d=_.partial(c,a,"remove");return{startWait:b,endWait:d}}},{}],35:[function(a,b){b.exports=function(b){var c=a("../util/IdFactory")(b);return{selector:{span:{get:function(a){return b.find("#"+a)}},entity:{get:function(a){return b.find("#"+c.makeEntityDomId(a))}},grid:{get:function(a){return b.find("#G"+a)}}}}}},{"../util/IdFactory":36}],36:[function(a,b){var c=[],d=function(a,b){return a+"__"+b},e=function(a,b,c){return d(a,b)+c},f="_";b.exports=function(a){var b=d(a.editorId,"S");return{makeSpanId:function(a){return b+a.begin+f+a.end},parseSpanId:function(a){var c=a.replace(b,"").split(f);return{begin:Number(c[0]),end:Number(c[1])}},makeTypeId:function(a,b){return-1===c.indexOf(b)&&c.push(b),a+"-"+c.indexOf(b)},makeEntityDomId:_.partial(e,a.editorId,"E"),makeParagraphId:_.partial(e,a.editorId,"P")}}},{}],37:[function(a,b){var c=function(a){return!a||""===a},d=function(a,b,d){c(a)||$.ajax({type:"GET",url:a,cache:!1}).done(function(a){void 0!==b&&b(a)}).fail(function(){void 0!==d&&d()})},e=function(a,b,d,e,f){c(a)||(console.log("POST data",b),$.ajax({type:"post",url:a,contentType:"application/json",data:b,crossDomain:!0,xhrFields:{withCredentials:!0}}).done(d).fail(e).always(f))};b.exports=function(){return{getAsync:d,post:e}}()},{}],38:[function(a,b){b.exports=function(a){return a.charAt(0).toUpperCase()+a.slice(1)}},{}],39:[function(a,b){var c=function(a,b,c){return $("<div>").attr("id",a).attr("title",b).hide().append(c)},d=function(a,b){return{open:function(){a.dialog(b)},close:function(){a.dialog("close")}}},e=function(a,b){return _.extend(b,new d(b,a))},f=function(a){return $("body").append(a),a};b.exports=function(a,b,d,g){a=_.extend({resizable:!1,modal:!0},a);var h=_.partial(e,a),i=_.compose(f,h,c);return i(b,d,g)}},{}],40:[function(a,b){var c=a("./Dialog"),d=function(a,b){return a+"."+b};b.exports=function(a,b,e,f,g){var h={width:550,height:220,buttons:g?{}:{Cancel:function(){$(this).dialog("close")}}},i=new c(h,d(a,b),e,f);return _.extend(i,{id:b})}},{"./Dialog":39}],41:[function(a,b){var c=function(a,b){return a[b]},d=function(a,b,c){return a[b]=c,c};b.exports=function(a){var b={},e=_.partial(c,b),f=_.partial(d,b),g=function(a,b){return object=a.apply(null,b),f(object.id,object)};return function(b){return e(b)||g(a,arguments)}}},{}],42:[function(a,b){var c=a("./EditorDialog"),d=a("./FunctionUseCache");b.exports=function(a){return a.getDialog=a.getDialog||new d(_.partial(c,a.editorId)),a.getDialog}},{"./EditorDialog":40,"./FunctionUseCache":41}],43:[function(a,b){var c=a("./ToolDialog"),d=a("./FunctionUseCache");b.exports=new d(c)},{"./FunctionUseCache":41,"./ToolDialog":44}],44:[function(a,b){var c=a("./Dialog");b.exports=function(a,b,d,e){var f=new c(d,a,b,e);return _.extend(f,{id:a})}},{"./Dialog":39}],45:[function(a,b){var c=function(){var a={};return{bind:function(b,c){if(!_.isFunction(c))throw new Error("Only a function is bindable!");return a[b]=a[b]||[],a[b].push(c),this},unbind:function(b,c){return a[b]?(a[b]=_.reject(a[b],function(a){return a===c}),this):this},trigger:function(b,c){return a[b]&&a[b].forEach(function(a){a(c)}),c}}};b.exports=function(a){return _.extend({},a,c())}},{}],46:[function(a,b){b.exports=function(a){var b=a?String(a).replace(/^\?(.*)/,"$1"):"",c=b.length>0?b.split("&"):[];return c.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).reduce(function(a,b){return a[b.key]=b.val?b.val:!0,a},{})}},{}],47:[function(a,b){b.exports=function(a,b){b?a.removeAttr("disabled"):a.attr("disabled","disabled")}},{}],48:[function(a,b){var c=function(a,b,c,d){var e={};return e[a]=d,b.find(c).prop(e).end()};b.exports={enabled:jQueryEnabled=a("./jQueryEnabled"),Div:function(a){return $("<div>").addClass(a)},Label:function(a,b){return $("<label>").addClass(a).text(b)},Button:function(a,b){return $('<input type="button" disabled="disabled" />').addClass(b).val(a)},Checkbox:function(a){return $('<input type="checkbox"/>').addClass(a)},Number:function(a){return $('<input type="number"/>').addClass(a)},toLink:function(a){return'<a href="'+a+'">'+a+"</a>"},getValueFromText:function(a,b){return a.find('[type="text"].'+b).val()},setChecked:_.partial(c,"checked"),setValue:_.partial(c,"value")}},{"./jQueryEnabled":47}],49:[function(a,b){b.exports=function(a,b){return a[b.name]=b,a}},{}],50:[function(a,b){b.exports={isUri:function(a){return String(a).indexOf("http")>-1},getUrlMatches:function(a){var b=/\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi;return b.exec(a)}}},{}],51:[function(a,b){var c=function(b){var c=a("../util/reduce2hash"),d=function(a){var c=!1,d=function(a){return void 0===a?c:(c=a,void f())},e=function(){c=!c,f()},f=function(){b.tool.push(a,c)};return{name:a,value:d,toggle:e,propagate:f}},e=["replicate-auto","relation-edit-mode","negation","speculation"].map(d),f=function(){e.map(function(a){return a.propagate}).forEach(function(a){a()})},g=e.reduce(c,{});return _.extend(g,{propagate:f})},d=function(a){var b={},c=function(a,c){b[a]=c},d=function(){a.tool.changeButtonState(a,b)};return{set:c,propagate:d}},e=function(a,b,c){var d=a.selectionModel,e=function(a){return _.isFunction(a)?a():d[a].some()},f=function(){for(var a=0;a<arguments.length;a++)if(!e(arguments[a]))return!1;return!0},g=function(){for(var a=0;a<arguments.length;a++)if(e(arguments[a]))return!0;return!1},h=function(){return c.clipBoard.length>0},i=_.partial(g,"span","entity"),j=_.partial(g,"entity","relation"),k={replicate:function(){return!!d.span.single()},entity:d.span.some,"delete":d.some,copy:i,paste:_.partial(f,h,"span"),pallet:j,"change-label":j,negation:j,speculation:j};return function(a){a.forEach(function(a){b.set(a,k[a]())})}},f=function(a,b){var c=function(a,b){return b.length>0&&_.every(b,function(b){return _.contains(b,a)})},d=function(a,d){b[a.toLowerCase()].value(c(a,d))};return function(b){var c=b.all().map(function(b){return a.annotationData.getModificationOf(b).map(function(a){return a.pred})});d("Negation",c),d("Speculation",c)}},g=function(a,b,c,d,e){var f=["delete"],g=f.concat(["replicate","entity","copy","paste"]),h=f.concat(["pallet","change-label","negation","speculation"]),i=h.concat(["copy"]),j=_.compose(b.propagate,c.propagate),k=_.partial(_.compose,j);return{propagate:j,enabled:k(c.set),updateBySpan:k(_.partial(d,g)),updateByEntity:_.compose(j,_.partial(e,a.selectionModel.entity),_.partial(d,i)),updateByRelation:_.compose(j,_.partial(e,a.selectionModel.relation),_.partial(d,h))}};b.exports=function(a,b,h){var i=new c(a),j=new d(a),k=new e(b,j,h),l=new f(b,i),m=new g(b,i,j,k,l);return{modeAccordingToButton:i,buttonStateHelper:m}}},{"../util/reduce2hash":49}],52:[function(a,b){var c=function(){var a={},b=function(b,c){return a[b]=c,c},c=function(b){return a[b]},d=function(b){delete a[b]},e=function(){a={}};return{set:b,get:c,remove:d,clear:e,keys:function(){return Object.keys(a)}}},d=function(){var a=[],b=function(b){a.push(b)},d=function(a,b,c){return a.get(c)?a.get(c):a.set(c,b(c))},e=function(a){var e=new c;return b(e),_.partial(d,e,a)},f=function(){a.forEach(function(a){a.clear()})};return{create:e,clear:f}}(),e=function(b,e){var f=a("../util/DomUtil")(b),g=_.extend(new c,{isGridPrepared:function(a){var b=e.get(a).span;return g.get(b)}}),h=function(){return b.find(".textae-editor__body__text-box").offset()},i=d.create(h),j=function(a){var b=f.selector.span.get(a);if(0===b.length)throw new Error("span is not renderd : "+a);var c=b.offset();return{top:c.top-i().top,left:c.left-i().left,width:b.outerWidth(),height:b.outerHeight(),center:b.get(0).offsetLeft+b.outerWidth()/2}},k=function(a){var b=f.selector.entity.get(a);if(0===b.length)throw new Error("entity is not rendered : "+a);var c=e.get(a).span,d=g.get(c),h=b.get(0);return{top:d.top+h.offsetTop,center:d.left+h.offsetLeft+b.outerWidth()/2}},l=new c,m=function(a){return l.get(a)},n=d.create(j),o=d.create(k);return{reset:d.clear,getSpan:n,getEntity:o,gridPositionCache:g,getGrid:g.get,setGrid:g.set,toConnect:m,connectCache:l}};b.exports=function(a,b){return a.postionCache=a.postionCache||e(a,b),a.postionCache}},{"../util/DomUtil":35}],53:[function(a,b){var c=function(a){return a&&a.hasClass("hidden")?a:void 0},d=function(a){a&&a.removeClass("hidden")};b.exports=function(b,e){var f=a("./DomPositionCache")(b,e.entity),g=a("../util/DomUtil")(b),h=function(a,b){var c=f.getGrid(a.id);return c&&c.top===b.top&&c.left===b.left?void 0:b},i=function(a){return a?g.selector.grid.get(a.id):void 0},j=function(a,b){return b?(i(a).css(b),f.setGrid(a.id,b),a):void 0},k=function(a,b){var c=function(a){var b=f.getSpan(a.id);return{top:b.top-i(a).outerHeight(),left:b.left}},d=function(b){var c=function(b){var d=0===b.children.length?0:Math.max.apply(null,b.children.map(function(a){return c(a)})),e=b.getTypes().length*(18*a+18);return e+d},d=f.getSpan(b.id),e=c(b);return{top:d.top-e,left:d.left}};return 0===b.children.length?c(b):d(b)},l=a("Promise"),m=function(a,b){var f=_.compose(_.partial(j,b),_.partial(h,b),_.partial(k,a)),g=_.compose(d,c,i);e.span.get(b.id)&&_.compose(g,f)(b)},n=function(a,b){return new l(function(c,d){_.defer(function(){try{m(a,b),c()}catch(e){d()}})})},o=function(a){return e.span.all().filter(function(a){return a.getTypes().length>0}).map(function(a){return f.getSpan(a.id),a}).map(_.partial(n,a))},p=function(a){return f.reset(),l.all(o(a))};return{arrangePosition:p}}},{"../util/DomUtil":35,"./DomPositionCache":52,Promise:2}],54:[function(a,b){var c=a("./selectionClass");b.exports=function(b,d){var e=a("./DomPositionCache")(b,d.annotationData.entity),f=a("../util/DomUtil")(b),g=function(a,b,d){var e=f.selector[a].get(d);c[b+"Class"](e)},h=_.partial(g,"span","add"),i=_.partial(g,"span","remove"),j=_.partial(g,"entity","add"),k=_.partial(g,"entity","remove"),l=function(a){var b=function(a){a&&a.select&&a.select()},c=_.compose(b,e.toConnect);c(a)},m=function(a){var b=function(a){a&&a.deselect&&a.deselect()},c=_.compose(b,e.toConnect);c(a)},n=function(a){var b=f.selector.entity.get(a),d=b.parent(),e=d.prev();d.children().length===d.find(".ui-selected").length?c.addClass(e):c.removeClass(e)};return{span:{select:h,deselect:i},entity:{select:j,deselect:k},relation:{select:l,deselect:m},entityLabel:{update:n}}}},{"../util/DomUtil":35,"./DomPositionCache":52,"./selectionClass":62}],55:[function(a,b){b.exports=function(b){var c=a("../util/reduce2hash"),d=a("../util/uri"),e="something",f=function(a,b){var c={},f=e;return{setDefinedTypes:function(a){c=a},getDeinedTypes:function(){return _.extend({},c)},setDefaultType:function(a){f=a},getDefaultType:function(){return f||this.getSortedNames()[0]},getColor:function(a){return c[a]&&c[a].color||b},getUri:function(a){return c[a]&&c[a].uri||d.getUrlMatches(a)?a:void 0},getSortedNames:function(){if(a){var b=a().concat(Object.keys(c)).reduce(function(a,b){return a[b]=a[b]?a[b]+1:1,a},{}),d=Object.keys(b);return d.sort(function(a,c){var d=b[c]-b[a];return 0!==d?d:a>c?1:a>c?-1:0}),d}return[]}}},g=function(a,b){void 0!==b&&(a.setDefinedTypes(b.reduce(c,{})),a.setDefaultType(b.filter(function(a){return a["default"]===!0}).map(function(a){return a.name}).shift()||e))},h=_.extend(new f(b.annotationData.entity.types,"#77DDDD"),{isBlock:function(a){var b=h.getDeinedTypes()[a];return b&&b.type&&"block"===b.type}}),i=new f(b.annotationData.relation.types,"#555555");return{entity:h,setDefinedEntityTypes:_.partial(g,h),relation:i,setDefinedRelationTypes:_.partial(g,i)}}},{"../util/reduce2hash":49,"../util/uri":50}],56:[function(a,b){var c=function(a){return _.partial(_.delay,a,150)},d=function(b,c,d,e){var f=a("./Selector")(b,c),g=function(a){b.removeClass("textae-editor_term-mode").removeClass("textae-editor_instance-mode").removeClass("textae-editor_relation-mode").addClass("textae-editor_"+a+"-mode")},h=function(a){d.buttonStateHelper.enabled("replicate-auto",!a),d.modeAccordingToButton["relation-edit-mode"].value(a)},i=_.compose(d.buttonStateHelper.updateByEntity,f.entityLabel.update),j=function(a){b.find(".textae-editor__body__text-box").css({"line-height":a+"px","padding-top":a/2+"px"})},k=function(a){var b=23,d=60,e=64,f=18*a+18,g=_.max(c.annotationData.span.all().map(function(a){var c=b+d,e=function(a){c+=a.getTypes().length*f,a.parent&&e(a.parent)};return e(a),c}).concat(e));j(g)},l=0,m=function(a){return{height:18*a+18+"px","padding-top":18*a+"px"}},n={getTypeGapValue:function(){return l},setTerm:function(){g("term"),h(!1),c.selectionModel.unbind("entity.select",i).unbind("entity.deselect",i).unbind("entity.change",i).bind("entity.select",i).bind("entity.deselect",i).bind("entity.change",d.buttonStateHelper.updateByEntity)},setInstance:function(){g("instance"),h(!1),c.selectionModel.unbind("entity.select",i).unbind("entity.deselect",i).unbind("entity.change",d.buttonStateHelper.updateByEntity).bind("entity.select",i).bind("entity.deselect",i).bind("entity.change",d.buttonStateHelper.updateByEntity)},setRelation:function(){g("relation"),h(!0),c.selectionModel.unbind("entity.select",i).unbind("entity.deselect",i).unbind("entity.change",d.buttonStateHelper.updateByEntity)},setEditable:function(a){a?(b.addClass("textae-editor_editable"),d.buttonStateHelper.enabled("relation-edit-mode",!0)):(b.removeClass("textae-editor_editable"),d.buttonStateHelper.enabled("replicate-auto",!1),d.buttonStateHelper.enabled("relation-edit-mode",!1))},getLineHeight:function(){return parseInt(b.find(".textae-editor__body__text-box").css("line-height"))/16},changeLineHeight:j,changeTypeGap:function(a){l!==a&&(-1!==a&&(b.find(".textae-editor__type").css(new m(a)),k(a),e(a)),l=a)},getTypeStyle:function(){return new m(l)}};return n};b.exports=function(b,e){var f=a("./Selector")(b,e),g={clipBoard:[]},h=a("./ButtonController")(b,e,g),i=a("./TypeContainer")(e),j=a("./renderer/Renderer")(b,e,h,i),k=a("./GridLayout")(b,e.annotationData),l=a("../util/extendBindable")({}),m=function(a){l.trigger("render.start",b),_.defer(function(){k.arrangePosition(a).then(j.renderLazyRelationAll).then(j.arrangeRelationPositionAll).then(function(){l.trigger("render.end",b)}).catch(function(a){console.error(a,a.stack)})})},n=new d(b,e,h,m),o=function(){var c=a("./DomPositionCache")(b,e.annotationData.entity),d=function(a,b){e.annotationData.entity.assosicatedRelations(b).map(c.toConnect).filter(function(a){return a.pointup&&a.pointdown}).forEach(a)};return{on:_.partial(d,function(a){a.pointup()}),off:_.partial(d,function(a){a.pointdown()})}}(),p=function(){e.selectionModel.bind("span.select",f.span.select).bind("span.deselect",f.span.deselect).bind("span.change",h.buttonStateHelper.updateBySpan).bind("entity.select",f.entity.select).bind("entity.deselect",f.entity.deselect).bind("relation.select",c(f.relation.select)).bind("relation.deselect",c(f.relation.deselect)).bind("relation.change",h.buttonStateHelper.updateByRelation)},q=function(){m(n.getTypeGapValue())};return j.bind("change",q).bind("entity.render",function(a){j.setEntityCss(a,n.getTypeStyle())}),_.extend(l,{init:_.compose(p,j.setModelHandler),viewModel:h,clipBoard:g,viewMode:n,hoverRelation:o,updateDisplay:q,typeContainer:i})}},{"../util/extendBindable":45,"./ButtonController":51,"./DomPositionCache":52,"./GridLayout":53,"./Selector":54,"./TypeContainer":55,"./renderer/Renderer":59}],57:[function(a,b){var c=function(a){var b=a.outerWidth(),c=a.find(".textae-editor__entity").toArray().map(function(a){return a.offsetWidth}).reduce(function(a,b){return a+b},0);a.css({left:c>b?(b-c)/2:0})},d=a("../../util/uri"),e=function(a){if(d.isUri(a)){var b=d.getUrlMatches(a);if(b)return b[9]?b[9].slice(1):b[6]?b[6]+(b[7]||""):b[5]?b[5].split("/").filter(function(a){return""!==a}).pop():b[3]}return a};b.exports=function(b,f,g,h,i){var j=a("../../util/DomUtil")(b),k=a("../../util/IdFactory")(b),l=function(a,b){return $("#"+k.makeTypeId(a,b))},m=function(a){return 0===f.annotationData.span.get(a).getTypes().length},n=function(){var a=function(a,b){return 0===f.annotationData.span.get(a.span).getTypes().filter(function(a){return a.name===b}).length};return function(b){var d=j.selector.entity.get(b.id).remove().attr("type");a(b,d)?l(b.span,d).remove():c(l(b.span,d).find(".textae-editor__entity-pane"))}}(),o=function(){var a=function(){var a=function(a){return d.isUri(a)?a:g.entity.getUri(a)?g.entity.getUri(a):void 0},b=function(b,c){var d=k.makeTypeId(b,c),f=$("<div>").attr("id","P-"+d).addClass("textae-editor__entity-pane"),h=$("<div>").addClass("textae-editor__type-label").css({"background-color":g.entity.getColor(c)}),i=a(c);return i?h.append($('<a target="_blank"/>').attr("href",i).text(e(c))):h.text(e(c)),$("<div>").attr("id",d).addClass("textae-editor__type").append(h).append(f)},c=function(a){var b=j.selector.grid.get(a);return 0===b.length?h.render(a):b};return function(a,d){var e=l(a,d);return 0===e.length&&(e=b(a,d),c(a).append(e)),e}}(),b=function(a){var b=$("<div>").attr("id",k.makeEntityDomId(a.id)).attr("title",a.id).attr("type",a.type).addClass("textae-editor__entity").css({"border-color":g.entity.getColor(a.type)});return b.addClass(i.getClasses(a.id)),b};return function(d){d.type=String(d.type);var e=a(d.span,d.type).find(".textae-editor__entity-pane").append(b(d));c(e)}}(),p=a("../../util/extendBindable")({}),q=function(a){return g.entity.isBlock(a.type)||o(a),p.trigger("render",a),a},r=a("../Selector")(b,f),s=function(a){return n(a),q(a),f.selectionModel.entity.has(a.id)&&r.entity.select(a.id),a},t=function(a){var b=j.selector.entity.get(a.id);i.update(b,a.id)},u=function(a){return m(a.span)?h.remove(a.span):n(a),a};return _.extend(p,{render:q,change:s,changeModification:t,remove:u,getTypeDom:function(a){return l(a.span,a.type)}})}},{"../../util/DomUtil":35,"../../util/IdFactory":36,"../../util/extendBindable":45,"../../util/uri":50,"../Selector":54}],58:[function(a,c){var d=3,e={cssClass:"textae-editor__relation__label",id:"label"},f={xrate:.6,yrate:.05,c_offset:20},h=function(a){var b=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]});return b.setRenderMode(b.SVG),b.Defaults.Container=a,b},i=function(a){var b=a.getOverlay(e.id);if(!b)throw"no label overlay";return b},j=a("./jsPlumbArrowOverlayUtil");c.exports=function(c,k,l,m){var n,o=a("../../util/DomUtil")(c),p=a("../DomPositionCache")(c,k.annotationData.entity),q=function(a){n=h(a)},s=function(){var a=function(a){var c=a.slice(1);return r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16),"rgba("+r+", "+g+", "+b+", 1)"};return function(b){var c=k.annotationData.relation.get(b).type,d=l.relation.getColor(c);return{lineWidth:1,strokeStyle:a(d,1)}}}(),t=function(a){var b=a.relationId;return p.connectCache.set(b,a),a},u=function(a){return{sourceId:k.annotationData.relation.get(a).subj,targetId:k.annotationData.relation.get(a).obj}},v=function(a){if(k.annotationData.relation.get(a)){var b=u(a);return p.gridPositionCache.isGridPrepared(b.sourceId)&&p.gridPositionCache.isGridPrepared(b.targetId)}},w=function(a){return v(a.relationId)?a:void 0},x=function(a){var b=u(a),c=p.getEntity(b.sourceId),d=p.getEntity(b.targetId),e=c.center,g=d.center,h=c.top,i=d.top,j=Math.abs(e-g),k=Math.abs(h-i),l=j*f.xrate+k*f.yrate+f.c_offset;return l/=2.4},y=function(){var a=function(a){return delete a.render,a},b=function(a){return n.connect({source:o.selector.entity.get(a.subj),target:o.selector.entity.get(a.obj),anchors:["TopCenter","TopCenter"],connector:["Bezier",{curviness:x(a.id)}],paintStyle:new s(a.id),parameters:{id:a.id},cssClass:"textae-editor__relation",overlays:[["Arrow",j.NORMAL_ARROW],["Label",_.extend({},e,{label:"["+a.id+"] "+a.type,cssClass:e.cssClass+" "+m.getClasses(a.id)})]]})},f=function(a){return _.extend(b(a),{relationId:a.id})},g=function(){var a=function(){var a=function(a){return new i(a).addClass("hover"),a},b=function(a){return new i(a).removeClass("hover"),a},c=function(a){return new i(a).addClass("ui-selected"),a},e=function(a){return new i(a).removeClass("ui-selected"),a},f=function(a){return a.addClass("hover"),a},g=function(a){return a.removeClass("hover"),a},h=function(a){return a.addClass("ui-selected"),a},k=function(a){return a.removeClass("ui-selected"),a},l=function(a,b){return a.connector.canvas.classList.contains(b)},m=function(a,b,c){return function(){b(a)||c(a)}},n=function(a,b){return b.setPaintStyle(_.extend(a(),{lineWidth:d})),b},o=function(a,b){return b.setPaintStyle(a()),b};return function(d,i){var p=_.partial(s,d),q=_.partial(n,p),r=_.partial(o,p),t=_.partial(m,i,function(a){return l(a,"ui-selected")}),u=_.partial(m,i,function(a){return a.dead}),v=_.compose(f,a,q,j.showBigArrow),w=_.compose(g,b,r,j.hideBigArrow),x=_.compose(h,c,g,b,q,j.showBigArrow),y=_.compose(k,e,r,j.hideBigArrow);return{pointup:t(v),pointdown:t(w),select:u(x),deselect:u(y)}}}();return function(b){var c=b.relationId;return _.extend(b,new a(c,b))}}(),h=function(){var a=function(a,b,c){a.bind("mouseenter",b).bind("mouseexit",c)},b=function(a){a.pointup()},c=function(a){a.pointdown()},d=function(a){return a.component},e=function(d){return a(d,b,c),d},f=function(e){return a(new i(e),_.compose(b,d),_.compose(c,d)),e};return _.compose(f,e)}(),k=function(){var a=function(){var a=function(a){this.bind("click",a),this.getOverlay(e.id).bind("click",function(b,c){a(b.component,c)})};return _.extend({bindClickAction:a})};return function(b){return _.extend(b,new a(b))}}(),l=function(a){return c.trigger("textae.editor.jsPlumbConnection.add",a),a};return _.compose(t,l,k,h,g,f,a)}(),z=a("Promise"),A=function(){var a=function(a){return _.extend(a,{relationId:a.id})},b=function(a){w(a)&&y(a)},c=function(a){var c=function(){return new z(function(c,d){_.defer(function(){try{b(a),c(a)}catch(e){d(e)}})})};return _.extend(a,{render:c})};return _.compose(t,c,a)}(),B=function(a){var b=p.toConnect(a);if(!b)throw"no connect";return b},C=function(a){var b=new B(a.id),c=new s(a.id);b instanceof jsPlumb.Connection&&(k.selectionModel.relation.has(a.id)&&(c.lineWidth=d),b.setPaintStyle(c),new i(b).setLabel("["+a.id+"] "+a.type))},D=function(a){var b=new B(a.id);b instanceof jsPlumb.Connection&&m.update(new i(b),a.id)},E=function(a){var b=new B(a.id);n.detach(b),p.connectCache.remove(a.id),b.dead=!0},F=function(){k.annotationData.relation.all().map(function(a){return new B(a.id)}).filter(function(a){return a.setConnector&&a.connector.getCurviness()!==x(a.relationId)}).forEach(function(a){a.setConnector(["Bezier",{curviness:x(a.relationId)}]),j.resetArrows(a)})},G=function(){return z.all(k.annotationData.relation.all().filter(function(a){return a.render}).map(function(a){return a.render()}))},H=function(){k.selectionModel.relation.all().map(function(a){return new B(a)}).filter(function(a){return a instanceof jsPlumb.Connection}).forEach(function(a){a.select()})},I=function(){return new z(function(a,b){_.defer(function(){try{F(),n.repaintEverything(),H(),a()}catch(c){throw b(c),c}})})};return{init:q,reset:function(){n.reset(),p.connectCache.clear()},render:A,change:C,changeModification:D,remove:E,renderLazyRelationAll:G,arrangePositionAll:I}}},{"../../util/DomUtil":35,"../DomPositionCache":52,"./jsPlumbArrowOverlayUtil":61,Promise:2}],59:[function(a,b){var c=function(a,b,c){var d=a.find("."+c);return 0===d.length&&(d=$("<"+b+">").addClass(c),a.append(d)),d},d=function(a){return a.id},e=a("../../util/capitalize");b.exports=function(b,f,g,h){var i=_.partial(c,b,"div","textae-editor__body"),j=function(){return c(i(),"div","textae-editor__body__annotation-box")},k=function(){var a=function(){return c(i(),"div","textae-editor__body__text-box")},b=function(a){return a.sourceDoc.split("\n").map(function(b,c){return'<p class="textae-editor__body__text-box__paragraph-margin"><span class="textae-editor__body__text-box__paragraph" id="'+a.paragraphs[c].id+'" >'+b+"</span></p>"}).join("\n")};return function(c){a().html(b(c))}}(),l=a("../DomPositionCache")(b,f.annotationData.entity),m=function(){var a=function(a){a.span.topLevel().forEach(function(a){n.span.render(a)})},b=function(a){n.relation.reset(),a.relation.all().forEach(n.relation.render)};return function(c){j().empty(),l.gridPositionCache.clear(),a(c),b(c)}}(),n=function(){var c=function(){var d=a("../../util/DomUtil")(b),e=function(a,b){var c=l.getSpan(b),d=$("<div>").attr("id","G"+b).addClass("textae-editor__grid").addClass("hidden").css({width:c.width});return a.append(d),d},f=function(a){d.selector.grid.get(a).remove(),l.gridPositionCache.remove(a)},g=function(a){c.render=_.partial(e,a)};return{init:g,render:null,remove:f}}(),d=function(){var a=function(a){return f.annotationData.getModificationOf(a).map(function(a){return"textae-editor__"+a.pred.toLowerCase()}).join(" ")};return{getClasses:a,update:function(){var b="textae-editor__negation textae-editor__speculation";return function(c,d){c.removeClass(b),c.addClass(a(d))}}()}}(),e=a("./EntityRenderer")(b,f,h,c,d),g=a("./SpanRenderer")(b,f,h,e,c),i=a("./RelationRenderer")(b,f,h,d);return{init:function(a){c.init(a),i.init(a)},span:g,entity:e,relation:i}}(),o=a("../../util/extendBindable")({}),p=_.debounce(function(){o.trigger("change")},100),q=_.partial(_.compose,p),r=function(){var a=function(a){return f.annotationData.span.get(a.span)};return _.partial(_.compose,p,n.span.change,a)}(),s=function(){var a=function(a,b){var c=f.annotationData[a].get(b.obj);return c&&(n[a].changeModification(c),g.buttonStateHelper["updateBy"+e(a)]()),b},b=_.partial(a,"entity"),c=_.partial(a,"relation");return _.compose(b,c)}();return n.entity.bind("render",function(a){return o.trigger("entity.render",a),a}),_.extend(o,{setModelHandler:function(){n.init(j()),f.annotationData.bind("change-text",k).bind("all.change",_.compose(f.selectionModel.clear,m)).bind("span.add",q(n.span.render)).bind("span.remove",q(n.span.remove)).bind("span.remove",_.compose(f.selectionModel.span.remove,d)).bind("entity.add",r(n.entity.render)).bind("entity.change",r(n.entity.change)).bind("entity.remove",r(n.entity.remove)).bind("entity.remove",_.compose(f.selectionModel.entity.remove,d)).bind("relation.add",q(n.relation.render)).bind("relation.change",n.relation.change).bind("relation.remove",n.relation.remove).bind("relation.remove",_.compose(f.selectionModel.relation.remove,d)).bind("modification.add",s).bind("modification.remove",s)},arrangeRelationPositionAll:n.relation.arrangePositionAll,renderLazyRelationAll:n.relation.renderLazyRelationAll,setEntityCss:function(a,b){n.entity.getTypeDom(a).css(b)}}),o}},{"../../util/DomUtil":35,"../../util/capitalize":38,"../../util/extendBindable":45,"../DomPositionCache":52,"./EntityRenderer":57,"./RelationRenderer":58,"./SpanRenderer":60}],60:[function(a,b){var c=function(a,b){var c=a.begin-b,d=a.end-b;return{start:c,end:d}},d=function(a,b,c){if(a.start<0||b.length<a.end)throw new Error("oh my god! I cannot render this span. "+c.toStringOnlyThis()+", textNode "+b.textContent)},e=function(a,b){var c=document.createRange();return c.setStart(a,b.start),c.setEnd(a,b.end),c},f=function(a,b,f){var g=c(a,b);return d(g,f,a),e(f,g)},g=function(){return 3===this.nodeType},h=function(a){return a.contents().filter(g).get(0)},i=function(a){return $("#"+a)},j=function(a,b,c){var d=_.compose(h,a),e=d(c.id);return f(b,c.begin,e)},k=_.partial(j,i),l=function(a){var b=document.createElement("span");return b.setAttribute("id",a.id),b.setAttribute("title",a.id),b.setAttribute("class","textae-editor__span"),b},m=function(a){return null!==document.getElementById(a.id)},n=function(a){return!a};b.exports=function(b,c,d,e,g){var h=a("../../util/DomUtil")(b),i=function(a){var b=_.partial(j,h.selector.span.get),c=a.getBigBrother();return c?f(a,c.end,document.getElementById(c.id).nextSibling):a.parent?b(a,a.parent):k(a,a.paragraph)},o=function(a,b){return i(a).surroundContents(b),a},p=function(a){return o(a,l(a))},q=function(a){return a.getTypes().filter(function(a){return d.entity.isBlock(a.name)}).length>0},r=function(a){var b=h.selector.span.get(a.id);return q(a)?b.addClass("textae-editor__span--block"):b.removeClass("textae-editor__span--block"),a},s=function(a){a.entities.forEach(_.compose(e.render,c.annotationData.entity.get))},t=function(a){return a.getTypes().forEach(s),a},u=function(a){for(var b=document.getElementById(a.id),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);$(b).remove(),c.normalize(),g.remove(a.id)},v=function(a){var b=function(a){a.children.forEach(function(a){b(a)}),u(a)};return a.children.filter(m).forEach(b),a},w=function(a){return a.children.filter(_.compose(n,m)).forEach(x),a},x=_.compose(w,t,r,p,v);return{render:x,remove:u,change:r}}},{"../../util/DomUtil":35}],61:[function(a,b){var c={width:7,length:9,location:1,id:"normal-arrow"},d={width:14,length:18,location:1,id:"hover-arrow"},e=function(a,b){return a===c.id?b.addOverlay(["Arrow",c]):a===d.id&&b.addOverlay(["Arrow",d]),b
},f=function(a,b){return b.forEach(function(b){e(b,a)}),b},g=function(a){return a.getOverlays().filter(function(a){return"Arrow"===a.type}).map(function(a){return a.id})},h=function(a){return a.getOverlay(c.id)},i=function(a){return a.getOverlay(d.id)},j=function(a,b){return b.removeOverlay(a),b},k=function(a,b){return b.forEach(function(b){j(b,a)}),b},l=function(a){_.compose(_.partial(f,a),_.partial(k,a),g)(a)},m=_.partial(e,c.id),n=_.partial(e,d.id),o=_.partial(j,c.id),p=_.partial(j,d.id),q=_.compose(n,o),r=_.compose(m,p);b.exports={NORMAL_ARROW:c,resetArrows:l,showBigArrow:function(a){return i(a)?a:q(a)},hideBigArrow:function(a){return h(a)?a:r(a)}}},{}],62:[function(a,b){b.exports=function(){var a=function(a){return a.addClass("ui-selected")},b=function(a){return a.removeClass("ui-selected")};return{addClass:a,removeClass:b}}()},{}]},{},[15]),function(){$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);